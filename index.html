<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–ª–∏–Ω–∏—á–Ω–∞ –ü—ä—Ç–µ–∫–∞ ‚Äî –í–∞–ª–∏–¥–∞—Ç–æ—Ä</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f0f2f5; --card: #ffffff; --primary: #1a56db; --primary-dark: #1642a8;
      --text: #1e293b; --text-muted: #64748b; --border: #dde2e9;
      --green: #16a34a; --green-bg: #ecfdf5; --green-border: #86efac;
      --red: #dc2626; --red-bg: #fef2f2; --red-border: #fca5a5;
      --amber-bg: #fffbeb; --amber-border: #fcd34d; --amber-text: #92400e;
      --orange: #ea580c; --orange-bg: #fff7ed; --orange-border: #fdba74;
      --radius: 14px; --shadow: 0 4px 24px rgba(0,0,0,0.07);
    }
    body {
      font-family: 'IBM Plex Sans', sans-serif; background: var(--bg);
      color: var(--text); min-height: 100vh; padding: 24px 16px;
      -webkit-font-smoothing: antialiased;
    }
    .page-wrap { display: flex; gap: 18px; max-width: 1060px; margin: 0 auto; align-items: flex-start; }
    .container { flex: 1; min-width: 0; max-width: 660px; }

    /* Floating reminder */
    .reminder-panel {
      flex: 0 0 280px; position: sticky; top: 24px;
      background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%);
      border: 2px solid #f9e14a; border-radius: 14px;
      padding: 20px; box-shadow: 0 4px 20px rgba(249,225,74,0.18);
      display: none; animation: slideIn 0.35s ease;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .reminder-panel.visible { display: block; }
    .reminder-title {
      font-size: 13px; font-weight: 800; color: #b7791f;
      display: flex; align-items: center; gap: 6px; margin-bottom: 10px;
      text-transform: uppercase; letter-spacing: 0.4px;
    }
    .reminder-text { font-size: 14px; font-weight: 500; color: #744210; line-height: 1.55; }

    @media (max-width: 860px) {
      .page-wrap { flex-direction: column; align-items: stretch; }
      .container { max-width: 100%; }
      .reminder-panel { flex: none; position: static; }
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #1a56db 0%, #3730a3 100%);
      border-radius: var(--radius) var(--radius) 0 0;
      padding: 24px 28px; display: flex; align-items: center; gap: 14px;
      box-shadow: var(--shadow);
    }
    .header-icon {
      width: 46px; height: 46px; background: rgba(255,255,255,0.15);
      border-radius: 12px; display: flex; align-items: center; justify-content: center;
      font-size: 22px; flex-shrink: 0;
    }
    .header h1 { font-size: 20px; font-weight: 800; color: #fff; letter-spacing: -0.3px; }
    .header p { font-size: 12px; color: rgba(200,215,255,0.85); margin-top: 3px; }

    /* Card */
    .card {
      background: var(--card); border-radius: 0 0 var(--radius) var(--radius);
      padding: 28px; box-shadow: var(--shadow);
    }
    label { display: block; font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 6px; }
    select, textarea {
      width: 100%; border: 1.5px solid var(--border); border-radius: 10px;
      padding: 12px 14px; font-family: 'IBM Plex Sans', sans-serif;
      font-size: 14px; color: var(--text); background: #fff; outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    select:focus, textarea:focus {
      border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26,86,219,0.12);
    }
    textarea {
      font-family: 'JetBrains Mono', monospace; font-size: 12.5px;
      height: 200px; resize: vertical; line-height: 1.6;
    }
    textarea::placeholder { color: #a0aec0; }
    .field + .field { margin-top: 18px; }

    /* Buttons */
    .btn-row { display: flex; gap: 10px; margin-top: 22px; }
    .btn-check {
      flex: 1; padding: 14px;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 15px; font-weight: 700; color: #fff;
      background: var(--primary); border: none; border-radius: 12px;
      cursor: pointer; transition: background 0.2s, transform 0.1s;
      box-shadow: 0 2px 8px rgba(26,86,219,0.25);
    }
    .btn-check:hover { background: var(--primary-dark); }
    .btn-check:active { transform: scale(0.985); }
    .btn-check:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; }
    .btn-arrange {
      flex: 1; padding: 14px;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 15px; font-weight: 700; color: #fff;
      background: #059669; border: none; border-radius: 12px;
      cursor: pointer; transition: background 0.2s, transform 0.1s;
      box-shadow: 0 2px 8px rgba(5,150,105,0.25);
    }
    .btn-arrange:hover { background: #047857; }
    .btn-arrange:active { transform: scale(0.985); }
    .btn-arrange:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; }
    .btn-reset {
      flex: 0 0 52px; padding: 14px 0;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 15px; font-weight: 700; color: #fff;
      background: #64748b; border: none; border-radius: 12px;
      cursor: pointer; transition: background 0.2s, transform 0.1s;
      box-shadow: 0 2px 8px rgba(100,116,139,0.25);
    }
    .btn-reset:hover { background: #475569; }

    /* Results */
    .results { margin-top: 24px; }
    .progress-header {
      display: flex; justify-content: space-between;
      font-size: 12px; font-weight: 500; color: var(--text-muted); margin-bottom: 5px;
    }
    .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 99px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 99px; transition: width 0.7s cubic-bezier(0.4,0,0.2,1); }
    .progress-fill.green { background: var(--green); }
    .progress-fill.yellow { background: #eab308; }
    .progress-fill.red { background: var(--red); }

    /* Banners */
    .banner {
      margin-top: 18px; border-radius: 16px; padding: 36px 20px;
      text-align: center; border-width: 2px; border-style: solid;
      animation: bannerIn 0.4s ease;
    }
    @keyframes bannerIn {
      from { opacity: 0; transform: translateY(12px) scale(0.97); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .banner-success { background: var(--green-bg); border-color: var(--green-border); }
    .banner-fail { background: var(--red-bg); border-color: var(--red-border); }
    .banner-icon { font-size: 60px; margin-bottom: 8px; }
    .banner h2 { font-size: 28px; font-weight: 800; letter-spacing: -0.5px; }
    .banner-success h2 { color: var(--green); }
    .banner-fail h2 { color: var(--red); }
    .banner .sub { margin-top: 6px; font-size: 14px; font-weight: 500; }
    .banner-success .sub { color: #15803d; }
    .banner-fail .sub { color: #b91c1c; }

    .missing-tags { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 16px; }
    .tag {
      display: inline-flex; align-items: center; gap: 5px;
      background: #fee2e2; color: #991b1b; border: 1px solid #fecaca;
      padding: 5px 12px; border-radius: 99px; font-size: 13px; font-weight: 600;
    }
    .tag-group { background: #fef3c7; color: #92400e; border-color: #fde68a; }

    .warning-box {
      margin-top: 18px; background: var(--amber-bg); border: 1.5px solid var(--amber-border);
      border-radius: 12px; padding: 14px 18px; text-align: center;
      color: var(--amber-text); font-weight: 500; font-size: 14px;
    }
    .warning-banner {
      margin-top: 14px; background: var(--orange-bg);
      border: 2px solid var(--orange-border); border-radius: 14px;
      padding: 18px 22px; text-align: center;
      animation: pulse 1.5s ease-in-out infinite alternate;
    }
    @keyframes pulse {
      from { box-shadow: 0 0 0 0 rgba(234,88,12,0.2); }
      to { box-shadow: 0 0 0 8px rgba(234,88,12,0); }
    }
    .warning-banner-text {
      font-size: 16px; font-weight: 800; color: var(--orange);
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }

    /* Details */
    .details-toggle {
      margin-top: 16px; background: none; border: none;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 13px; font-weight: 600; color: var(--primary);
      cursor: pointer; display: flex; align-items: center; gap: 6px; padding: 0;
    }
    .details-toggle:hover { color: var(--primary-dark); }
    .details-grid {
      margin-top: 12px; display: grid; grid-template-columns: 1fr 1fr;
      gap: 6px; max-height: 400px; overflow-y: auto; animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .detail-item {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 12px; border-radius: 8px; font-size: 13px;
    }
    .detail-item.found { background: var(--green-bg); color: #166534; }
    .detail-item.missing { background: var(--red-bg); color: #991b1b; font-weight: 600; }
    .detail-item.group-header {
      grid-column: 1 / -1; background: #f1f5f9; color: #475569;
      font-weight: 700; font-size: 12px; text-transform: uppercase;
      letter-spacing: 0.5px; padding: 6px 12px; margin-top: 6px;
    }
    .detail-item.group-ok { background: #ecfdf5; color: #166534; }
    .detail-item.group-fail { background: #fef2f2; color: #991b1b; font-weight: 600; }
    .detail-icon { flex-shrink: 0; }

    /* Arranged output */
    .arranged-output {
      margin-top: 24px; background: #f8fafc; border: 1.5px solid var(--border);
      border-radius: 12px; overflow: hidden; animation: fadeIn 0.3s ease;
    }
    .arranged-header {
      background: #059669; color: #fff; padding: 12px 18px;
      font-weight: 700; font-size: 14px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .btn-copy {
      background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
      color: #fff; padding: 5px 12px; border-radius: 8px; cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif; font-size: 12px; font-weight: 600;
      transition: background 0.2s;
    }
    .btn-copy:hover { background: rgba(255,255,255,0.3); }
    .arranged-body {
      padding: 18px; font-family: 'JetBrains Mono', monospace;
      font-size: 12.5px; line-height: 1.8; white-space: pre-wrap;
      max-height: 500px; overflow-y: auto; color: var(--text);
    }
    .val-found { color: #059669; font-weight: 600; }
    .val-missing { color: #dc2626; font-weight: 600; font-style: italic; }
    .val-ketone { color: #dc2626; font-weight: 800; background: #fef2f2; padding: 1px 6px; border-radius: 4px; }
    .section-label { color: #1a56db; font-weight: 700; display: block; margin-top: 10px; }
    .inline-results { display: inline; }
    .inline-results span { white-space: nowrap; }
    .bold-label { font-weight: 800; }
    .egfr-box {
      margin-top: 8px; padding: 10px 14px; border-radius: 10px;
      border: 2px solid #6366f1; background: #eef2ff;
      font-size: 13px; line-height: 1.6;
    }
    .egfr-box b { color: #4338ca; }
    .egfr-stage { font-weight: 700; padding: 2px 8px; border-radius: 6px; font-size: 12px; }
    .egfr-stage.g1 { background: #dcfce7; color: #166534; }
    .egfr-stage.g2 { background: #fef9c3; color: #854d0e; }
    .egfr-stage.g3a { background: #fed7aa; color: #9a3412; }
    .egfr-stage.g3b { background: #fdba74; color: #7c2d12; }
    .egfr-stage.g4 { background: #fecaca; color: #991b1b; }
    .egfr-stage.g5 { background: #dc2626; color: #fff; }
    .patient-input-panel {
      margin-top: 16px; padding: 18px; background: #f8fafc;
      border: 1.5px solid var(--border); border-radius: 12px;
      animation: fadeIn 0.3s ease;
    }
    .patient-input-panel h3 {
      font-size: 14px; font-weight: 700; color: var(--text); margin-bottom: 12px;
    }
    .patient-fields { display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
    .patient-field label { font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 4px; }
    .patient-field input, .patient-field select {
      width: 120px; padding: 8px 10px; border: 1.5px solid var(--border);
      border-radius: 8px; font-family: 'IBM Plex Sans', sans-serif;
      font-size: 14px; outline: none;
    }
    .patient-field input:focus, .patient-field select:focus {
      border-color: var(--primary); box-shadow: 0 0 0 2px rgba(26,86,219,0.1);
    }
    .btn-compute {
      padding: 8px 18px; background: #059669; color: #fff; border: none;
      border-radius: 8px; font-family: 'IBM Plex Sans', sans-serif;
      font-size: 14px; font-weight: 700; cursor: pointer; transition: background 0.2s;
    }
    .btn-compute:hover { background: #047857; }

    @media (max-width: 500px) {
      .details-grid { grid-template-columns: 1fr; }
      .banner h2 { font-size: 22px; }
      .banner-icon { font-size: 48px; }
    }
    .footer { text-align: center; font-size: 11px; color: #a0aec0; margin-top: 18px; }
  </style>
</head>
<body>

<div class="page-wrap">
  <div class="container">
    <div class="header">
      <div class="header-icon">üè•</div>
      <div>
        <h1>–ö–ª–∏–Ω–∏—á–Ω–∞ –ü—ä—Ç–µ–∫–∞ ‚Äî –í–∞–ª–∏–¥–∞—Ç–æ—Ä</h1>
        <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–∞ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏ –∏–∑—Å–ª–µ–¥–≤–∞–Ω–∏—è</p>
      </div>
    </div>

    <div class="card">
      <div class="field">
        <label for="pathway">–ö–ª–∏–Ω–∏—á–Ω–∞ –ø—ä—Ç–µ–∫–∞:</label>
        <select id="pathway">
          <option value="">‚Äî –ò–∑–±–µ—Ä–µ—Ç–µ –∫–ª–∏–Ω–∏—á–Ω–∞ –ø—ä—Ç–µ–∫–∞ ‚Äî</option>
          <option value="–ê–ü 13">–ê–ü 13</option>
          <option value="–ê–ü 14">–ê–ü 14 (–æ—á–∞–∫–≤–∞–π—Ç–µ —Å–∫–æ—Ä–æ)</option>
          <option value="–ê–ü 15">–ê–ü 15 (–æ—á–∞–∫–≤–∞–π—Ç–µ —Å–∫–æ—Ä–æ)</option>
          <option value="–ö–ü 78.1">–ö–ü 78.1</option>
          <option value="–ö–ü 79.1">–ö–ü 79.1</option>
          <option value="–ö–ü 80.1">–ö–ü 80.1</option>
          <option value="–ö–ü 81.1">–ö–ü 81.1</option>
        </select>
      </div>
      <div class="field">
        <label for="inputText">–¢–µ–∫—Å—Ç –∑–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞:</label>
        <textarea id="inputText" placeholder="–ü–æ—Å—Ç–∞–≤–µ—Ç–µ —Ç–µ–∫—Å—Ç–∞ —Å —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ –æ—Ç –∏–∑—Å–ª–µ–¥–≤–∞–Ω–∏—è —Ç—É–∫..."></textarea>
      </div>
      <div class="btn-row">
        <button class="btn-check" id="checkBtn" disabled>üîç –ü—Ä–æ–≤–µ—Ä–∏</button>
        <button class="btn-arrange" id="arrangeBtn" disabled>üìã –ü–æ–¥—Ä–µ–¥–∏</button>
        <button class="btn-reset" id="resetBtn" title="–ò–∑—á–∏—Å—Ç–∏">üîÑ</button>
      </div>
      <div id="results" class="results"></div>
      <div id="arranged" class="results"></div>
    </div>
    <p class="footer">–ö–ª–∏–Ω–∏—á–Ω–∞ –ü—ä—Ç–µ–∫–∞ –í–∞–ª–∏–¥–∞—Ç–æ—Ä 2026 made by Stefan Radev</p>
  </div>

  <!-- Floating reminder panel -->
  <div class="reminder-panel" id="reminderPanel">
    <div class="reminder-title">üíä –ù–∞–ø–æ–º–Ω—è–Ω–µ</div>
    <div class="reminder-text" id="reminderText"></div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REMINDER MESSAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var REMINDERS = {
  "–ö–ü 78.1": "–ù–µ –∑–∞–±—Ä–∞–≤—è–π, —á–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –∏–º–∞ –∏–∑–ø–∏—Å–∞–Ω–∏ –î–í–ï —Ä–∞–∑–ª–∏—á–Ω–∏ –ª–µ—á–µ–±–Ω–∏ –≤–µ—â–µ—Å—Ç–≤–∞ (–Ω–∞–ø—Ä. –µ–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç + –ª–µ—á–µ–±–Ω–æ –≤–µ—â–µ—Å—Ç–≤–æ).",
  "–ö–ü 79.1": "–ù–µ –∑–∞–±—Ä–∞–≤—è–π, —á–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –∏–º–∞ –∏–∑–ø–∏—Å–∞–Ω–æ –ï–î–ù–û –ª–µ—á–µ–±–Ω–æ –≤–µ—â–µ—Å—Ç–≤–æ (–Ω–∞–ø—Ä. –µ–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç –∏–ª–∏ –¥—Ä.).",
  "–ö–ü 80.1": "–ù–µ –∑–∞–±—Ä–∞–≤—è–π, —á–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –∏–º–∞ –∏–∑–ø–∏—Å–∞–Ω–æ –ï–î–ù–û –ª–µ—á–µ–±–Ω–æ –≤–µ—â–µ—Å—Ç–≤–æ (–Ω–∞–ø—Ä. –µ–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç –∏–ª–∏ –¥—Ä.).",
  "–ö–ü 81.1": "–ù–µ –∑–∞–±—Ä–∞–≤—è–π, —á–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –∏–º–∞ –∏–∑–ø–∏—Å–∞–Ω–æ –ï–î–ù–û –ª–µ—á–µ–±–Ω–æ –≤–µ—â–µ—Å—Ç–≤–æ (–Ω–∞–ø—Ä. –µ–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç –∏–ª–∏ –¥—Ä.).",
  "–ö–ü 83.3": "–ù–µ –∑–∞–±—Ä–∞–≤—è–π, —á–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –∏–º–∞ –∏–∑–ø–∏—Å–∞–Ω–æ –ï–î–ù–û –ª–µ—á–µ–±–Ω–æ –≤–µ—â–µ—Å—Ç–≤–æ (–Ω–∞–ø—Ä. –µ–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç –∏–ª–∏ –¥—Ä.).",
  "–ê–ü 13": "–ù–µ –∑–∞–±—Ä–∞–≤—è–π, —á–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –∏–º–∞ –∏–∑–ø–∏—Å–∞–Ω–æ –ï–î–ù–û –ª–µ—á–µ–±–Ω–æ –≤–µ—â–µ—Å—Ç–≤–æ (–Ω–∞–ø—Ä. –µ–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç –∏–ª–∏ –¥—Ä.)."
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function matchSingle(text, kw) {
  if (kw.alternatives) return kw.alternatives.some(function(a) { return text.indexOf(a) !== -1; });
  if (kw.regex) return kw.regex.test(text);
  return text.indexOf(kw.search) !== -1;
}

// Normalize text: remove invisible characters that hospital systems embed
function normalizeText(raw) {
  return raw
    .replace(/[\u200B\u200C\u200D\uFEFF\u00AD\u200E\u200F\u202A-\u202E]/g, '')  // zero-width & direction chars
    .replace(/\u00A0/g, ' ')  // non-breaking space ‚Üí regular space
    .replace(/\s+/g, function(m) { return m.indexOf('\n') !== -1 ? '\n' : ' '; }); // collapse whitespace
}

// Extract ALL values for a parameter from text
function extractAllValues(text, pattern) {
  var results = [];
  var re = new RegExp(pattern, 'g');
  var m;
  while ((m = re.exec(text)) !== null) {
    results.push(m[1]);
  }
  return results;
}

// Extract a free-text block starting from a marker to the next section or semicolon block
function extractFreeText(text, startMarker) {
  for (var i = 0; i < startMarker.length; i++) {
    var idx = text.indexOf(startMarker[i]);
    if (idx !== -1) {
      // grab from that marker to the end of sentence / next major section
      var sub = text.substring(idx);
      // Try to find a natural endpoint
      var endPatterns = [/\n\n/, /–õ–∞–±\.‚Ññ/, /\d{2}\.\d{2}\.\d{4}\s*-\s*(?!.*$)/];
      var endIdx = sub.length;
      // just take a reasonable chunk - up to 500 chars or next –õ–∞–±.‚Ññ
      var labIdx = sub.indexOf("–õ–∞–±.‚Ññ", 10);
      if (labIdx > 0) endIdx = labIdx;
      return sub.substring(0, endIdx).trim();
    }
  }
  return null;
}

// Shared keyword sets
var BLOOD_COUNT = [
  { label: "–õ–µ–≤–∫–æ—Ü–∏—Ç–∏", search: "–õ–µ–≤–∫–æ—Ü–∏—Ç–∏" },
  { label: "–•–µ–º–æ–≥–ª–æ–±–∏–Ω", search: "–•–µ–º–æ–≥–ª–æ–±–∏–Ω" },
  { label: "–ï—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–∏", search: "–ï—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–∏" },
  { label: "–•–µ–º–∞—Ç–æ–∫—Ä–∏—Ç", search: "–•–µ–º–∞—Ç–æ–∫—Ä–∏—Ç" },
  { label: "MCV", regex: /\bMCV\b/ },
  { label: "MCH", regex: /\bMCH\b/ },
  { label: "MCHC", regex: /\bMCHC\b/ },
  { label: "–¢—Ä–æ–º–±–æ—Ü–∏—Ç–∏", search: "–¢—Ä–æ–º–±–æ—Ü–∏—Ç–∏" }
];
var THYROID_PANEL = [
  { label: "FT4", regex: /\bFT4\b/ },
  { label: "TSH", regex: /\bTSH\b/ },
  { label: "Anti TG (TAT)", search: "Anti TG" },
  { label: "Anti-TPO (MAT)", search: "Anti-TPO" }
];
var UZD_SHIA = { label: "–£–ó–î –Ω–∞ —à–∏—è / –ï—Ö–æ–≥—Ä–∞—Ñ–∏—è –Ω–∞ —à–∏—è", alternatives: ["–£–ó–î –Ω–∞ —à–∏—è", "–ï–•–û–ì–†–ê–§–ò–Ø –ù–ê –®–ò–Ø", "–ï—Ö–æ–≥—Ä–∞—Ñ–∏—è –Ω–∞ —à–∏—è", "–µ—Ö–æ–≥—Ä–∞—Ñ–∏—è –Ω–∞ —à–∏—è"] };


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PATHWAY CHECK FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkPathway(pathway, text) {
  switch (pathway) {
    case "–ö–ü 78.1": return checkKP78(text);
    case "–ö–ü 79.1": return checkKP79(text);
    case "–ö–ü 80.1": return checkKP80(text);
    case "–ö–ü 81.1": return checkKP81(text);
    case "–ê–ü 13":   return checkAP13(text);
    default: return null;
  }
}

function checkKP78(text) {
  var items = [];
  BLOOD_COUNT.forEach(function(kw) { items.push({ label: kw.label, found: matchSingle(text, kw), type: "required" }); });
  var biochem = [
    { label: "ASAT", regex: /\bASAT\b/ },
    { label: "ALAT", regex: /\bALAT\b/ },
    { label: "GGT", regex: /\bGGT\b/ },
    { label: "–ê–ª–∫–∞–ª–Ω–∞ —Ñ–æ—Å—Ñ–∞—Ç–∞–∑–∞ / –ê–§", alternatives: ["–ê–ª–∫–∞–ª–Ω–∞ —Ñ–æ—Å—Ñ–∞—Ç–∞–∑–∞", "–ê–§"] },
    { label: "–•–æ–ª–µ—Å—Ç–µ—Ä–æ–ª", search: "–•–æ–ª–µ—Å—Ç–µ—Ä–æ–ª" },
    { label: "HDL", regex: /\bHDL\b/ },
    { label: "LDL", regex: /\bLDL\b/ },
    { label: "–¢—Ä–∏–≥–ª–∏—Ü–µ—Ä–∏–¥–∏", search: "–¢—Ä–∏–≥–ª–∏—Ü–µ—Ä–∏–¥–∏" },
    { label: "–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω - —Å–µ—Ä—É–º", search: "–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω - —Å–µ—Ä—É–º" },
    { label: "–£—Ä–µ—è", search: "–£—Ä–µ—è" },
    { label: "–ì–ª–∏–∫–∏—Ä–∞–Ω —Ö–µ–º–æ–≥–ª–æ–±–∏–Ω", search: "–ì–ª–∏–∫–∏—Ä–∞–Ω —Ö–µ–º–æ–≥–ª–æ–±–∏–Ω" }
  ];
  biochem.forEach(function(kw) { items.push({ label: kw.label, found: matchSingle(text, kw), type: "required" }); });
  var glucose = [
    { label: "–ì–ª—é–∫–æ–∑–∞ - –ø—Ä–æ—Ñ–∏–ª 6—á", search: "–ì–ª—é–∫–æ–∑–∞ - –ø—Ä–æ—Ñ–∏–ª 6—á" },
    { label: "–ì–ª—é–∫–æ–∑–∞ - –ø—Ä–æ—Ñ–∏–ª 12—á", search: "–ì–ª—é–∫–æ–∑–∞ - –ø—Ä–æ—Ñ–∏–ª 12—á" },
    { label: "–ì–ª—é–∫–æ–∑–∞ - –ø—Ä–æ—Ñ–∏–ª 18—á", search: "–ì–ª—é–∫–æ–∑–∞ - –ø—Ä–æ—Ñ–∏–ª 18—á" }
  ];
  glucose.forEach(function(kw) { items.push({ label: kw.label, found: matchSingle(text, kw), type: "required" }); });
  var urineStrip = [
    { label: "–°–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ —Ç–µ–≥–ª–æ - —É—Ä–∏–Ω–∞", search: "–°–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ —Ç–µ–≥–ª–æ - —É—Ä–∏–Ω–∞" },
    { label: "–£—Ä–∏–Ω–∞ - –º–∏–∫—Ä–æ–∞–ª–±—É–º–∏–Ω", search: "–£—Ä–∏–Ω–∞ - –º–∏–∫—Ä–æ–∞–ª–±—É–º–∏–Ω" },
    { label: "–£—Ä–∏–Ω–∞ - –∞—Å–∫–æ—Ä–±–∏–Ω–æ–≤–∞ –∫-–Ω–∞", search: "–∞—Å–∫–æ—Ä–±–∏–Ω–æ–≤–∞ –∫-–Ω–∞" },
    { label: "pH - —É—Ä–∏–Ω–∞", search: "pH - —É—Ä–∏–Ω–∞" },
    { label: "–ë–µ–ª—Ç—ä–∫ - —É—Ä–∏–Ω–∞", search: "–ë–µ–ª—Ç—ä–∫ - —É—Ä–∏–Ω–∞" },
    { label: "–ì–ª—é–∫–æ–∑–∞ - —É—Ä–∏–Ω–∞", search: "–ì–ª—é–∫–æ–∑–∞ - —É—Ä–∏–Ω–∞" },
    { label: "–ö–µ—Ç–æ—Ç–µ–ª–∞ - —É—Ä–∏–Ω–∞", search: "–ö–µ—Ç–æ—Ç–µ–ª–∞ - —É—Ä–∏–Ω–∞" },
    { label: "–ë–∏–ª–∏—Ä—É–±–∏–Ω - —É—Ä–∏–Ω–∞", search: "–ë–∏–ª–∏—Ä—É–±–∏–Ω - —É—Ä–∏–Ω–∞" },
    { label: "–£—Ä–æ–±–∏–ª–∏–Ω–æ–≥–µ–Ω - —É—Ä–∏–Ω–∞", search: "–£—Ä–æ–±–∏–ª–∏–Ω–æ–≥–µ–Ω - —É—Ä–∏–Ω–∞" },
    { label: "–ù–∏—Ç—Ä–∏—Ç–∏ - —É—Ä–∏–Ω–∞", search: "–ù–∏—Ç—Ä–∏—Ç–∏ - —É—Ä–∏–Ω–∞" },
    { label: "–ö—Ä—ä–≤ - —É—Ä–∏–Ω–∞", search: "–ö—Ä—ä–≤ - —É—Ä–∏–Ω–∞" },
    { label: "–£—Ä–∏–Ω–∞ - –ª–µ–≤–∫–æ—Ü–∏—Ç–∏", search: "–£—Ä–∏–Ω–∞ - –ª–µ–≤–∫–æ—Ü–∏—Ç–∏" }
  ];
  urineStrip.forEach(function(kw) { items.push({ label: kw.label, found: matchSingle(text, kw), type: "required" }); });
  var sediment = [
    { label: "–°–µ–¥–∏–º–µ–Ω—Ç - –ï–†–ò–¢–†–û–¶–ò–¢–ò", search: "–°–µ–¥–∏–º–µ–Ω—Ç —É—Ä–∏–Ω–∞ - –ï–†–ò–¢–†–û–¶–ò–¢–ò" },
    { label: "–°–µ–¥–∏–º–µ–Ω—Ç - –õ–ï–í–ö–û–¶–ò–¢–ò", search: "–°–µ–¥–∏–º–µ–Ω—Ç —É—Ä–∏–Ω–∞ - –õ–ï–í–ö–û–¶–ò–¢–ò" },
    { label: "–°–µ–¥–∏–º–µ–Ω—Ç - –≥—Ä—É–ø–∏—Ä–∞–Ω–∏ –ª–µ–≤–∫–æ—Ü–∏—Ç–∏", search: "–≥—Ä—É–ø–∏—Ä–∞–Ω–∏ –ª–µ–≤–∫–æ—Ü–∏—Ç–∏" },
    { label: "–°–µ–¥–∏–º–µ–Ω—Ç - —Å–∫–≤–∞–º–æ–∑–Ω–∏ –µ–ø. –∫–ª–µ—Ç–∫–∏", search: "—Å–∫–≤–∞–º–æ–∑–Ω–∏" },
    { label: "–°–µ–¥–∏–º–µ–Ω—Ç - –ù–ï—Å–∫–≤–∞–º–æ–∑–Ω–∏ –µ–ø. –∫–ª–µ—Ç–∫–∏", search: "–ù–ï—Å–∫–≤–∞–º–æ–∑–Ω–∏" },
    { label: "–°–µ–¥–∏–º–µ–Ω—Ç - –±–∞–∫—Ç–µ—Ä–∏–∏", search: "–°–µ–¥–∏–º–µ–Ω—Ç —É—Ä–∏–Ω–∞ - –±–∞–∫—Ç–µ—Ä–∏–∏" },
    { label: "–°–µ–¥–∏–º–µ–Ω—Ç - –∫—Ä–∏—Å—Ç–∞–ª–∏", search: "–°–µ–¥–∏–º–µ–Ω—Ç —É—Ä–∏–Ω–∞ - –∫—Ä–∏—Å—Ç–∞–ª–∏" },
    { label: "–°–µ–¥–∏–º–µ–Ω—Ç - –°–õ–£–ó", search: "–°–µ–¥–∏–º–µ–Ω—Ç —É—Ä–∏–Ω–∞ - –°–õ–£–ó" },
    { label: "–°–µ–¥–∏–º–µ–Ω—Ç - —Ö–∏–∞–ª–∏–Ω–Ω–∏ —Ü–∏–ª–∏–Ω–¥—Ä–∏", search: "—Ö–∏–∞–ª–∏–Ω–Ω–∏ —Ü–∏–ª–∏–Ω–¥—Ä–∏" },
    { label: "–°–µ–¥–∏–º–µ–Ω—Ç - –ù–ï—Ö–∏–∞–ª–∏–Ω–Ω–∏ —Ü–∏–ª–∏–Ω–¥—Ä–∏", search: "–ù–ï—Ö–∏–∞–ª–∏–Ω–Ω–∏ —Ü–∏–ª–∏–Ω–¥—Ä–∏" },
    { label: "–°–µ–¥–∏–º–µ–Ω—Ç - –≥—ä–±–∏—á–∫–∏ (Candida)", search: "Candida" },
    { label: "–°–µ–¥–∏–º–µ–Ω—Ç - —Å–ø–µ—Ä–º–∞—Ç–æ–∑–æ–∏–¥–∏", search: "—Å–ø–µ—Ä–º–∞—Ç–æ–∑–æ–∏–¥–∏" }
  ];
  sediment.forEach(function(kw) { items.push({ label: kw.label, found: matchSingle(text, kw), type: "required" }); });
  var albCr = [
    { label: "–ê–ª–±—É–º–∏–Ω –≤ —É—Ä–∏–Ω–∞", search: "–ê–ª–±—É–º–∏–Ω –≤ —É—Ä–∏–Ω–∞" },
    { label: "–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω - —É—Ä–∏–Ω–∞", search: "–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω - —É—Ä–∏–Ω–∞" },
    { label: "–û—Ç–Ω–æ—à–µ–Ω–∏–µ –∞–ª–±—É–º–∏–Ω/–∫—Ä–µ–∞—Ç–∏–Ω–∏–Ω (AKR)", search: "AKR" }
  ];
  albCr.forEach(function(kw) { items.push({ label: kw.label, found: matchSingle(text, kw), type: "required" }); });
  items.push({ label: "–ï–ö–ì", found: /[–ïE][–öK][–ìG]/i.test(text), type: "required" });
  return { items: items, warnings: [] };
}

function checkKP79(text) {
  var items = [];
  BLOOD_COUNT.forEach(function(kw) { items.push({ label: kw.label, found: matchSingle(text, kw), type: "required" }); });
  THYROID_PANEL.forEach(function(kw) { items.push({ label: kw.label, found: matchSingle(text, kw), type: "required" }); });
  items.push({ label: UZD_SHIA.label, found: matchSingle(text, UZD_SHIA), type: "required" });
  return { items: items, warnings: [] };
}

function checkKP80(text) {
  var items = [];
  BLOOD_COUNT.forEach(function(kw) { items.push({ label: kw.label, found: matchSingle(text, kw), type: "required" }); });
  var hormones = [
    { label: "FT4", regex: /\bFT4\b/ },
    { label: "–ö–æ—Ä—Ç–∏–∑–æ–ª - —Å–µ—Ä—É–º", search: "–ö–æ—Ä—Ç–∏–∑–æ–ª" },
    { label: "LH", regex: /\bLH\b/ },
    { label: "FSH", regex: /\bFSH\b/ },
    { label: "–ï—Å—Ç—Ä–∞–¥–∏–æ–ª", search: "–ï—Å—Ç—Ä–∞–¥–∏–æ–ª" },
    { label: "–¢–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω", alternatives: ["Testosteron", "–¢–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω"] },
    { label: "GH / –†–∞—Å—Ç–µ–∂–µ–Ω —Ö–æ—Ä–º–æ–Ω", alternatives: ["GH", "–†–∞—Å—Ç–µ–∂–µ–Ω —Ö–æ—Ä–º–æ–Ω"] },
    { label: "IGF1", regex: /\bIGF1\b|IGF-1/ },
    { label: "–ê–ö–¢–•", alternatives: ["AKTH", "–ê–ö–¢–•"] },
    { label: "TSH / –¢–°–•", alternatives: ["TSH", "–¢–°–•"] },
    { label: "–ü—Ä–æ–ª–∞–∫—Ç–∏–Ω", alternatives: ["Prolactin", "–ü—Ä–æ–ª–∞–∫—Ç–∏–Ω"] }
  ];
  var hormoneFound = hormones.some(function(kw) { return matchSingle(text, kw); });
  items.push({
    label: "–ü–æ–Ω–µ 1 —Ö–æ—Ä–º–æ–Ω",
    found: hormoneFound, type: "oneOf",
    subItems: hormones.map(function(kw) { return { label: kw.label, found: matchSingle(text, kw) }; })
  });
  items.push({ label: "–ö–æ—Ä—Ç–∏–∑–æ–ª - —É—Ä–∏–Ω–∞ 24—á", found: text.indexOf("–ö–æ—Ä—Ç–∏–∑–æ–ª") !== -1 && text.indexOf("—É—Ä–∏–Ω–∞") !== -1, type: "required" });
  var imaging = [
    { label: "–£–ó–î –Ω–∞ —à–∏—è / –ï—Ö–æ–≥—Ä–∞—Ñ–∏—è", alternatives: ["–£–ó–î –Ω–∞ —à–∏—è", "–ï–•–û–ì–†–ê–§–ò–Ø –ù–ê –®–ò–Ø", "–ï—Ö–æ–≥—Ä–∞—Ñ–∏—è –Ω–∞ —à–∏—è", "–µ—Ö–æ–≥—Ä–∞—Ñ–∏—è –Ω–∞ —à–∏—è"] },
    { label: "–•–ò–ü–û–§–ò–ó–ê –ú–†", alternatives: ["–•–ò–ü–û–§–ò–ó–ê –ú–†", "—Ö–∏–ø–æ—Ñ–∏–∑–∞ –º—Ä", "–ú–† –Ω–∞ —Ö–∏–ø–æ—Ñ–∏–∑–∞"] },
    { label: "–ö–¢", alternatives: ["KT", "–ö–¢", "–ö–æ–º–ø—é—Ç—ä—Ä–Ω–∞ —Ç–æ–º–æ–≥—Ä–∞—Ñ–∏—è"] },
    { label: "–ï—Ö–æ—Å–∫–æ–ø–∏—è –∫–æ—Ä–µ–º–Ω–∏ –æ—Ä–≥–∞–Ω–∏", alternatives: ["–ï—Ö–æ—Å–∫–æ–ø–∏—è –Ω–∞ –∫–æ—Ä–µ–º–Ω–∏ –æ—Ä–≥–∞–Ω–∏", "–µ—Ö–æ—Å–∫–æ–ø–∏—è –Ω–∞ –∫–æ—Ä–µ–º–Ω–∏ –æ—Ä–≥–∞–Ω–∏"] },
    { label: "–†–ï–ù–¢–ì–ï–ù–û–ì–†–ê–§–ò–Ø", alternatives: ["–†–ï–ù–¢–ì–ï–ù–û–ì–†–ê–§–ò–Ø", "–†–µ–Ω—Ç–≥–µ–Ω–æ–≥—Ä–∞—Ñ–∏—è", "—Ä–µ–Ω—Ç–≥–µ–Ω–æ–≥—Ä–∞—Ñ–∏—è", "–†–µ–Ω—Ç–≥–µ–Ω–æ–≥—Ä–∞—Ñ"] }
  ];
  var imagingFound = imaging.some(function(kw) { return matchSingle(text, kw); });
  items.push({
    label: "–ü–æ–Ω–µ 1 –æ–±—Ä–∞–∑–Ω–æ –∏–∑—Å–ª–µ–¥–≤–∞–Ω–µ",
    found: imagingFound, type: "oneOf",
    subItems: imaging.map(function(kw) { return { label: kw.label, found: matchSingle(text, kw) }; })
  });
  return { items: items, warnings: [] };
}

function checkKP81(text) {
  var items = [];
  BLOOD_COUNT.forEach(function(kw) { items.push({ label: kw.label, found: matchSingle(text, kw), type: "required" }); });
  var kp81 = [
    { label: "ASAT", regex: /\bASAT\b/ },
    { label: "ALAT", regex: /\bALAT\b/ },
    { label: "GGT", regex: /\bGGT\b/ },
    { label: "–ê–ª–∫–∞–ª–Ω–∞ —Ñ–æ—Å—Ñ–∞—Ç–∞–∑–∞", search: "–ê–ª–∫–∞–ª–Ω–∞ —Ñ–æ—Å—Ñ–∞—Ç–∞–∑–∞" },
    { label: "–•–æ–ª–µ—Å—Ç–µ—Ä–æ–ª", search: "–•–æ–ª–µ—Å—Ç–µ—Ä–æ–ª" },
    { label: "VLDL", regex: /\bVLDL\b/ },
    { label: "HDL", regex: /\bHDL\b/ },
    { label: "LDL", regex: /\bLDL\b/ },
    { label: "–¢—Ä–∏–≥–ª–∏—Ü–µ—Ä–∏–¥–∏", search: "–¢—Ä–∏–≥–ª–∏—Ü–µ—Ä–∏–¥–∏" },
    { label: "–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω - —Å–µ—Ä—É–º", search: "–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω - —Å–µ—Ä—É–º" },
    { label: "–£—Ä–µ—è", search: "–£—Ä–µ—è" },
    { label: "cCa++", regex: /cCa/ },
    { label: "–ö–∞–ª—Ü–∏–π", search: "–ö–∞–ª—Ü–∏–π" },
    { label: "–ù–µ–æ—Ä–≥–∞–Ω–∏—á–µ–Ω —Ñ–æ—Å—Ñ–∞—Ç", search: "–ù–µ–æ—Ä–≥–∞–Ω–∏—á–µ–Ω —Ñ–æ—Å—Ñ–∞—Ç" },
    { label: "Mg", regex: /\bMg\b/ },
    { label: "–ù–∞—Ç—Ä–∏–π", search: "–ù–∞—Ç—Ä–∏–π" },
    { label: "–ö–∞–ª–∏–π", search: "–ö–∞–ª–∏–π" },
    { label: "–•–ª–æ—Ä–∏–¥", search: "–•–ª–æ—Ä–∏–¥" },
    { label: "PTH", regex: /\bPTH\b/ },
    { label: "25 OH Vitamin D TOTAL", search: "25 OH Vitamin D" },
    { label: "Beta Cross Laps", search: "Beta Cross Laps" },
    { label: "–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω–æ–≤ –∫–ª–∏—Ä—ä–Ω—Å", search: "–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω–æ–≤ –∫–ª–∏—Ä—ä–Ω—Å" },
    { label: "–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω - —É—Ä–∏–Ω–∞", search: "–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω - —É—Ä–∏–Ω–∞" },
    { label: "–ö–∞–ª—Ü–∏–π 24—á- —É—Ä–∏–Ω–∞", search: "–ö–∞–ª—Ü–∏–π 24—á" },
    { label: "–§–æ—Å—Ñ–æ—Ä 24—á- —É—Ä–∏–Ω–∞", search: "–§–æ—Å—Ñ–æ—Ä 24—á" },
    { label: "–î–∏—É—Ä–µ–∑–∞ (–î-–º–ª)", regex: /–î-\d/ },
    { label: "–û—Å—Ç–µ–æ–º–µ—Ç—Ä–∏—è –Ω–∞ –¥–≤–µ –æ–±–ª–∞—Å—Ç–∏", search: "–û—Å—Ç–µ–æ–º–µ—Ç—Ä–∏—è" },
    { label: "–£–ó–î –Ω–∞ —à–∏—è", search: "–£–ó–î –Ω–∞ —à–∏—è" }
  ];
  kp81.forEach(function(kw) { items.push({ label: kw.label, found: matchSingle(text, kw), type: "required" }); });
  return { items: items, warnings: [] };
}

function checkAP13(text) {
  var items = [];
  var warnings = [];
  items.push({ label: UZD_SHIA.label, found: matchSingle(text, UZD_SHIA), type: "required" });
  var hasCytology = text.indexOf("–¶–∏—Ç–æ–ª–æ–≥–∏—á–Ω–æ –∏–∑—Å–ª–µ–¥–≤–∞–Ω–µ") !== -1 || text.indexOf("—Ü–∏—Ç–æ–ª–æ–≥–∏—á–Ω–æ –∏–∑—Å–ª–µ–¥–≤–∞–Ω–µ") !== -1 || text.indexOf("—Ç—ä–Ω–∫–æ–∏–≥–ª–µ–Ω–∞ –∞—Å–ø–∏—Ä–∞—Ü–∏–æ–Ω–Ω–∞ –±–∏–æ–ø—Å–∏—è") !== -1 || text.indexOf("–¢–ê–ë") !== -1;
  items.push({ label: "–¶–∏—Ç–æ–ª–æ–≥–∏—á–Ω–æ –∏–∑—Å–ª–µ–¥–≤–∞–Ω–µ / –¢–ê–ë", found: hasCytology, type: "required" });
  if (!hasCytology) {
    items.push({ label: "‚îÄ‚îÄ –ù—è–º–∞ —Ü–∏—Ç–æ–ª–æ–≥–∏—è ‚Üí –Ω—É–∂–Ω–∏ —Å–∞ –¥–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ –∏–∑—Å–ª–µ–¥–≤–∞–Ω–∏—è ‚îÄ‚îÄ", found: false, type: "conditional-info" });
    BLOOD_COUNT.forEach(function(kw) { items.push({ label: kw.label, found: matchSingle(text, kw), type: "required" }); });
    THYROID_PANEL.forEach(function(kw) { items.push({ label: kw.label, found: matchSingle(text, kw), type: "required" }); });
    warnings.push("‚ö†Ô∏è –ù–µ –∑–∞–±—Ä–∞–≤—è–π –¥–∞ –∏–∑–ø–∏—à–µ—à –ª–µ—á–µ–±–Ω–æ –≤–µ—â–µ—Å—Ç–≤–æ!!!");
  }
  return { items: items, warnings: warnings };
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VALUE EXTRACTION / ARRANGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Generic extractor: finds all occurrences of "label ... - VALUE"
function extractParam(text, paramPatterns, unit) {
  for (var p = 0; p < paramPatterns.length; p++) {
    var pattern = paramPatterns[p];
    var vals = extractAllValues(text, pattern + '(?:\\s*\\([^)]*\\))?\\s*-\\s*([\\d.,><!=]+)');
    if (vals.length > 0) {
      return vals.map(function(v, i) {
        return (i === 0 ? '' : ' ; ') + v + (unit ? ' ' + unit : '');
      }).join('');
    }
  }
  return null;
}

function formatLine(label, value, unit) {
  if (value !== null) {
    return '<span>' + label + ' - <span class="val-found">' + value + '</span></span>\n';
  }
  return '<span>' + label + ' - <span class="val-missing">–Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–æ</span></span>\n';
}

function formatLineBold(label, value) {
  if (value !== null) {
    return '<span><b class="bold-label">' + label + '</b> - <span class="val-found">' + value + '</span></span>\n';
  }
  return '<span><b class="bold-label">' + label + '</b> - <span class="val-missing">–Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–æ</span></span>\n';
}

function formatLineInline(label, value) {
  if (value !== null) {
    return '<span>' + label + ' - <span class="val-found">' + value + '</span></span>; ';
  }
  return '<span>' + label + ' - <span class="val-missing">???</span></span>; ';
}

function arrangeKP81(text) {
  var out = '';
  var params = [
    { label: "–õ–µ–≤–∫–æ—Ü–∏—Ç–∏", patterns: ["–õ–µ–≤–∫–æ—Ü–∏—Ç–∏(?:\\s*\\(WBC\\))?"], unit: "10*9/L" },
    { label: "–•–µ–º–æ–≥–ª–æ–±–∏–Ω", patterns: ["–•–µ–º–æ–≥–ª–æ–±–∏–Ω(?:\\s*\\(HGB\\))?"], unit: "g/L" },
    { label: "–ï—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–∏", patterns: ["–ï—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–∏(?:\\s*\\(RBC\\))?"], unit: "10*12/L" },
    { label: "–•–µ–º–∞—Ç–æ–∫—Ä–∏—Ç", patterns: ["–•–µ–º–∞—Ç–æ–∫—Ä–∏—Ç(?:\\s*\\(HCT\\))?"], unit: "L/L" },
    { label: "MCV", patterns: ["MCV"], unit: "fL" },
    { label: "MCH", patterns: ["MCH(?!C)"], unit: "pg" },
    { label: "MCHC", patterns: ["MCHC"], unit: "g/L" },
    { label: "–¢—Ä–æ–º–±–æ—Ü–∏—Ç–∏", patterns: ["–¢—Ä–æ–º–±–æ—Ü–∏—Ç–∏(?:\\s*\\(PLT\\))?"], unit: "10*9/L" },
    { label: "ASAT", patterns: ["(?:–ê—Å–ø–∞—Ä—Ç–∞—Ç –∞–º–∏–Ω–æ—Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞–∑–∞ \\(ASAT\\)|ASAT)(?:\\s*-\\s*—Å–µ—Ä—É–º)?"], unit: "U/L" },
    { label: "ALAT", patterns: ["(?:–ê–ª–∞–Ω–∏–Ω –∞–º–∏–Ω–æ—Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞–∑–∞ \\(ALAT\\)|ALAT)(?:\\s*-\\s*—Å–µ—Ä—É–º)?"], unit: "U/L" },
    { label: "GGT", patterns: ["(?:–ì–∞–º–∞ –≥–ª—É—Ç–∞–º–∏–ª —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞–∑–∞ \\(GGT\\)|GGT)(?:\\s*-\\s*—Å–µ—Ä—É–º)?"], unit: "U/L" },
    { label: "–ê–ª–∫–∞–ª–Ω–∞ —Ñ–æ—Å—Ñ–∞—Ç–∞–∑–∞", patterns: ["–ê–ª–∫–∞–ª–Ω–∞ —Ñ–æ—Å—Ñ–∞—Ç–∞–∑–∞"], unit: "U/L" },
    { label: "–•–æ–ª–µ—Å—Ç–µ—Ä–æ–ª", patterns: ["–•–æ–ª–µ—Å—Ç–µ—Ä–æ–ª"], unit: "mmol/L" },
    { label: "VLDL", patterns: ["VLDL"], unit: "mmol/L" },
    { label: "HDL", patterns: ["HDL(?!\\s)"], unit: "mmol/L" },
    { label: "LDL", patterns: ["LDL(?!\\s)"], unit: "mmol/L" },
    { label: "–¢—Ä–∏–≥–ª–∏—Ü–µ—Ä–∏–¥–∏", patterns: ["–¢—Ä–∏–≥–ª–∏—Ü–µ—Ä–∏–¥–∏"], unit: "mmol/L" },
    { label: "–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω - —Å–µ—Ä—É–º", patterns: ["–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω - —Å–µ—Ä—É–º"], unit: "umol/L" },
    { label: "–£—Ä–µ—è", patterns: ["–£—Ä–µ—è"], unit: "mmol/L" },
    { label: "cCa++", patterns: ["cCa\\s*\\+*\\s*(?:/[^/]*/)?"], unit: "mmol/L" },
    { label: "–ö–∞–ª—Ü–∏–π", patterns: ["–ö–∞–ª—Ü–∏–π(?!\\s*24)"], unit: "mmol/L" },
    { label: "–ù–µ–æ—Ä–≥–∞–Ω–∏—á–µ–Ω —Ñ–æ—Å—Ñ–∞—Ç", patterns: ["–ù–µ–æ—Ä–≥–∞–Ω–∏—á–µ–Ω —Ñ–æ—Å—Ñ–∞—Ç"], unit: "mmol/L" },
    { label: "Mg", patterns: ["Mg"], unit: "mmol/L" },
    { label: "–ù–∞—Ç—Ä–∏–π", patterns: ["–ù–∞—Ç—Ä–∏–π"], unit: "mmol/L" },
    { label: "–ö–∞–ª–∏–π", patterns: ["–ö–∞–ª–∏–π(?!\\s*24)"], unit: "mmol/L" },
    { label: "–•–ª–æ—Ä–∏–¥", patterns: ["–•–ª–æ—Ä–∏–¥"], unit: "mmol/L" },
    { label: "PTH", patterns: ["PTH"], unit: "pg/mL" },
    { label: "25 OH Vitamin D TOTAL", patterns: ["25 OH Vitamin D(?:\\s*TOTAL)?"], unit: "ng/mL" },
    { label: "Beta Cross Laps", patterns: ["Beta Cross Laps"], unit: "ng/mL" },
    { label: "–ò–Ω—Å—É–ª–∏–Ω - —Å–µ—Ä—É–º", patterns: ["–ò–Ω—Å—É–ª–∏–Ω(?:\\s*-\\s*—Å–µ—Ä—É–º)?"], unit: "u[IU]/mL" },
    { label: "–û–ì–¢–¢ –ì–ª—é–∫–æ–∑–∞ –Ω–∞ –≥–ª–∞–¥–Ω–æ", patterns: ["–û–ì–¢–¢ –ì–ª—é–∫–æ–∑–∞ –Ω–∞ –≥–ª–∞–¥–Ω–æ"], unit: "mmol/L" },
    { label: "–ì–ª—é–∫–æ–∑–∞ - –≤—Ç–æ—Ä–∏ —á–∞—Å", patterns: ["–ì–ª—é–∫–æ–∑–∞ - –≤—Ç–æ—Ä–∏ —á–∞—Å"], unit: "mmol/L" },
  ];

  out += '<span class="section-label">‚ïê‚ïê‚ïê –ö–†–™–í–ù–ò –ò–ó–°–õ–ï–î–í–ê–ù–ò–Ø ‚ïê‚ïê‚ïê</span>\n';
  params.forEach(function(p) {
    var val = extractParam(text, p.patterns, p.unit);
    out += formatLine(p.label, val);
  });

  // Urine section
  out += '<span class="section-label">‚ïê‚ïê‚ïê –£–†–ò–ù–ê ‚ïê‚ïê‚ïê</span>\n';
  var urineParams = [
    { label: "–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω - —Å–µ—Ä—É–º (–ø–æ–≤—Ç–æ—Ä–µ–Ω)", patterns: ["–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω - —Å–µ—Ä—É–º"], unit: "umol/L", idx: 1 },
    { label: "–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω–æ–≤ –∫–ª–∏—Ä—ä–Ω—Å", patterns: ["–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω–æ–≤ –∫–ª–∏—Ä—ä–Ω—Å"], unit: "mL/min" },
    { label: "–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω - —É—Ä–∏–Ω–∞", patterns: ["–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω - —É—Ä–∏–Ω–∞"], unit: "umol/L" },
    { label: "–ö–∞–ª—Ü–∏–π 24—á- —É—Ä–∏–Ω–∞", patterns: ["–ö–∞–ª—Ü–∏–π 24—á"], unit: "mmol/L" },
    { label: "–§–æ—Å—Ñ–æ—Ä 24—á- —É—Ä–∏–Ω–∞", patterns: ["–§–æ—Å—Ñ–æ—Ä 24—á"], unit: "mmol/L" },
  ];
  urineParams.forEach(function(p) {
    if (p.idx) {
      // Get specific occurrence
      var allVals = extractAllValues(text, p.patterns[0] + '(?:\\s*\\([^)]*\\))?\\s*-\\s*([\\d.,]+)');
      if (allVals.length > p.idx) {
        out += formatLine(p.label, allVals[p.idx] + ' ' + p.unit);
      } else if (allVals.length > 0) {
        out += formatLine(p.label, allVals[allVals.length - 1] + ' ' + p.unit);
      } else {
        out += formatLine(p.label, null);
      }
    } else {
      var val = extractParam(text, p.patterns, p.unit);
      out += formatLine(p.label, val);
    }
  });

  // Diuresis
  var diuresisMatch = text.match(/–î-(\d+)\s*–º–ª/);
  out += formatLine("–î–∏—É—Ä–µ–∑–∞", diuresisMatch ? diuresisMatch[1] + ' –º–ª' : null);

  // Osteometry
  out += '<span class="section-label">‚ïê‚ïê‚ïê –û–°–¢–ï–û–ú–ï–¢–†–ò–Ø ‚ïê‚ïê‚ïê</span>\n';
  var osteoText = extractFreeText(text, ["–û—Å—Ç–µ–æ–º–µ—Ç—Ä–∏—è"]);
  if (osteoText) {
    out += '<span class="val-found">' + osteoText + '</span>\n';
  } else {
    out += '<span class="val-missing">–ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞ –æ—Å—Ç–µ–æ–º–µ—Ç—Ä–∏—è</span>\n';
  }

  // FRAX
  var majorMatch = text.match(/Major osteoporotic risk\s*[:\-]?\s*([\d.,]+\s*%?)/i);
  var hipMatch = text.match(/Hip Fracture risk\s*[:\-]?\s*([\d.,]+\s*%?)/i);
  if (majorMatch || hipMatch) {
    out += '<span class="section-label">‚ïê‚ïê‚ïê FRAX ‚ïê‚ïê‚ïê</span>\n';
    out += formatLine("Major osteoporotic risk", majorMatch ? majorMatch[1] : null);
    out += formatLine("Hip Fracture risk", hipMatch ? hipMatch[1] : null);
  }

  // –£–ó–î –Ω–∞ —à–∏—è
  out += '<span class="section-label">‚ïê‚ïê‚ïê –ï–•–û–ì–†–ê–§–ò–Ø –ù–ê –®–ò–Ø ‚ïê‚ïê‚ïê</span>\n';
  var uzdText = extractFreeText(text, ["–ï–•–û–ì–†–ê–§–ò–Ø –ù–ê –®–ò–Ø", "–£–ó–î –Ω–∞ —à–∏—è", "–ï—Ö–æ–≥—Ä–∞—Ñ–∏—è –Ω–∞ —à–∏—è"]);
  if (uzdText) {
    out += '<span class="val-found">' + uzdText + '</span>\n';
  } else {
    out += '<span class="val-missing">–ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞ –µ—Ö–æ–≥—Ä–∞—Ñ–∏—è –Ω–∞ —à–∏—è</span>\n';
  }

  // –ï–ö–ì
  out += '<span class="section-label">‚ïê‚ïê‚ïê –ï–ö–ì ‚ïê‚ïê‚ïê</span>\n';
  var ekgText = extractFreeText(text, ["–ï–ö–ì-", "–ï–ö–ì -", "–ï–ö–ì:"]);
  if (ekgText) {
    out += '<span class="val-found">' + ekgText + '</span>\n';
  } else {
    out += '<span class="val-missing">–ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–æ –ï–ö–ì</span>\n';
  }

  return out;
}

// ‚îÄ‚îÄ Shared blood count extractor ‚îÄ‚îÄ
function arrangeBloodCount(text) {
  var out = '<span class="inline-results">';
  var bc = [
    { label: "–õ–µ–≤–∫–æ—Ü–∏—Ç–∏", patterns: ["–õ–µ–≤–∫–æ—Ü–∏—Ç–∏(?:\\s*\\(WBC\\))?"], unit: "10*9/L" },
    { label: "–•–µ–º–æ–≥–ª–æ–±–∏–Ω", patterns: ["–•–µ–º–æ–≥–ª–æ–±–∏–Ω(?:\\s*\\(HGB\\))?"], unit: "g/L" },
    { label: "–ï—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–∏", patterns: ["–ï—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–∏(?:\\s*\\(RBC\\))?"], unit: "10*12/L" },
    { label: "–•–µ–º–∞—Ç–æ–∫—Ä–∏—Ç", patterns: ["–•–µ–º–∞—Ç–æ–∫—Ä–∏—Ç(?:\\s*\\(HCT\\))?"], unit: "L/L" },
    { label: "MCV", patterns: ["MCV"], unit: "fL" },
    { label: "MCH", patterns: ["MCH(?!C)"], unit: "pg" },
    { label: "MCHC", patterns: ["MCHC"], unit: "g/L" },
    { label: "–¢—Ä–æ–º–±–æ—Ü–∏—Ç–∏", patterns: ["–¢—Ä–æ–º–±–æ—Ü–∏—Ç–∏(?:\\s*\\(PLT\\))?"], unit: "10*9/L" }
  ];
  bc.forEach(function(p) { out += formatLineInline(p.label, extractParam(text, p.patterns, p.unit)); });
  out += '</span>\n';
  return out;
}

// ‚îÄ‚îÄ Shared EKG extractor ‚îÄ‚îÄ
function arrangeEKG(text) {
  var out = '<span class="section-label">‚ïê‚ïê‚ïê –ï–ö–ì ‚ïê‚ïê‚ïê</span>\n';
  var ekgText = extractFreeText(text, ["–ï–ö–ì-", "–ï–ö–ì -", "–ï–ö–ì:", "EKG-", "EKG -", "EKG:"]);
  if (ekgText) {
    out += '<span class="val-found">' + ekgText + '</span>\n';
  } else {
    out += '<span class="val-missing">–ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–æ –ï–ö–ì</span>\n';
  }
  return out;
}

// ‚îÄ‚îÄ Shared UZD extractor ‚îÄ‚îÄ
function arrangeUZD(text) {
  var out = '<span class="section-label">‚ïê‚ïê‚ïê –ï–•–û–ì–†–ê–§–ò–Ø –ù–ê –®–ò–Ø ‚ïê‚ïê‚ïê</span>\n';
  var uzdText = extractFreeText(text, ["–ï–•–û–ì–†–ê–§–ò–Ø –ù–ê –®–ò–Ø", "–£–ó–î –Ω–∞ —à–∏—è", "–ï—Ö–æ–≥—Ä–∞—Ñ–∏—è –Ω–∞ —à–∏—è"]);
  if (uzdText) {
    out += '<span class="val-found">' + uzdText + '</span>\n';
  } else {
    out += '<span class="val-missing">–ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞ –µ—Ö–æ–≥—Ä–∞—Ñ–∏—è –Ω–∞ —à–∏—è</span>\n';
  }
  return out;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  eGFR CKD-EPI 2021
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function ckdEpi2021(scrUmol, age, sex) {
  // Convert umol/L to mg/dL: divide by 88.42
  var scrMgdl = scrUmol / 88.42;
  var kappa, alpha, genderFactor;
  if (sex === 'female') {
    kappa = 0.7; alpha = -0.241; genderFactor = 1.012;
  } else {
    kappa = 0.9; alpha = -0.302; genderFactor = 1.0;
  }
  var scrRatio = scrMgdl / kappa;
  var egfr = 142 * Math.pow(Math.min(scrRatio, 1), alpha)
           * Math.pow(Math.max(scrRatio, 1), -1.200)
           * Math.pow(0.9938, age)
           * genderFactor;
  return Math.round(egfr * 10) / 10;
}

function getCKDStage(egfr) {
  if (egfr >= 90)  return { stage: "G1", label: "G1-—Å—Ç.:–ù–æ—Ä–º–∞–ª–Ω–∞ –∏–ª–∏ —Ö–∏–ø–µ—Ä—Ñ–∏–ª—Å—Ç—Ä–∞—Ü–∏—è", cls: "g1" };
  if (egfr >= 60)  return { stage: "G2", label: "¬†G2-—Å—Ç:–õ–µ–∫–æ –Ω–∞–º–∞–ª–µ–Ω–∞", cls: "g2" };
  if (egfr >= 45)  return { stage: "G3a", label: "G3a-—Å—Ç:–õ–µ–∫–æ –¥–æ —É–º–µ—Ä–µ–Ω–æ –Ω–∞–º–∞–ª–µ–Ω–∞", cls: "g3a" };
  if (egfr >= 30)  return { stage: "G3b", label: "G3b-—Å—Ç:–£–º–µ—Ä–µ–Ω–æ –¥–æ —Ç–µ–∂–∫–æ –Ω–∞–º–∞–ª–µ–Ω–∞", cls: "g3b" };
  if (egfr >= 15)  return { stage: "G4", label: "G4-—Å—Ç:–¢–µ–∂–∫–æ –Ω–∞–º–∞–ª–µ–Ω–∞", cls: "g4" };
  return { stage: "G5", label: "G5-—Å—Ç.:–ë—ä–±—Ä–µ—á–Ω–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç—ä—á–Ω–æ—Å—Ç", cls: "g5" };
}

function getCreatinineForEGFR(text) {
  // Get all creatinine-serum values, use the last one (or lowest if only one)
  var allVals = extractAllValues(text, '–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω - —Å–µ—Ä—É–º(?:\\s*\\([^)]*\\))?\\s*-\\s*([\\d.,]+)');
  if (allVals.length === 0) return null;
  var nums = allVals.map(function(v) { return parseFloat(v.replace(',', '.')); });
  // Use the last value; if multiple, also find lowest as fallback
  return nums[nums.length - 1];
}

function computeEGFR(text, age, sex) {
  var scr = getCreatinineForEGFR(text);
  if (!scr || !age || !sex) return '';

  var egfr = ckdEpi2021(scr, age, sex);
  var ckd = getCKDStage(egfr);

  return '<div class="egfr-box">' +
    '<b>eGFR (CKD-EPI 2021)</b> = <span class="val-found">' + egfr + ' mL/min/1.73m¬≤</span>' +
    ' &nbsp;‚Üí&nbsp; <span class="egfr-stage ' + ckd.cls + '">' + ckd.stage + ': ' + ckd.label + '</span>' +
    '<br><span style="font-size:11px;color:#64748b;">–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω: ' + scr + ' umol/L | –í—ä–∑—Ä–∞—Å—Ç: ' + age + ' | –ü–æ–ª: ' + (sex === 'male' ? '–º—ä–∂' : '–∂–µ–Ω–∞') + '</span>' +
    '</div>\n';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ARRANGE: –ö–ü 78.1
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function arrangeKP78(text, age, sex) {
  var out = '';

  out += '<span class="section-label">‚ïê‚ïê‚ïê –ö–†–™–í–ù–ò –ò–ó–°–õ–ï–î–í–ê–ù–ò–Ø ‚ïê‚ïê‚ïê</span>\n';
  out += arrangeBloodCount(text);

  out += '<span class="inline-results">';
  var biochem = [
    { label: "ASAT", patterns: ["(?:–ê—Å–ø–∞—Ä—Ç–∞—Ç –∞–º–∏–Ω–æ—Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞–∑–∞ \\(ASAT\\)|ASAT)(?:\\s*-\\s*—Å–µ—Ä—É–º)?"], unit: "U/L" },
    { label: "ALAT", patterns: ["(?:–ê–ª–∞–Ω–∏–Ω –∞–º–∏–Ω–æ—Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞–∑–∞ \\(ALAT\\)|ALAT)(?:\\s*-\\s*—Å–µ—Ä—É–º)?"], unit: "U/L" },
    { label: "GGT", patterns: ["(?:–ì–∞–º–∞ –≥–ª—É—Ç–∞–º–∏–ª —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞–∑–∞ \\(GGT\\)|GGT)(?:\\s*-\\s*—Å–µ—Ä—É–º)?"], unit: "U/L" },
    { label: "–ê–ª–∫–∞–ª–Ω–∞ —Ñ–æ—Å—Ñ–∞—Ç–∞–∑–∞", patterns: ["–ê–ª–∫–∞–ª–Ω–∞ —Ñ–æ—Å—Ñ–∞—Ç–∞–∑–∞"], unit: "U/L" },
    { label: "–•–æ–ª–µ—Å—Ç–µ—Ä–æ–ª", patterns: ["–•–æ–ª–µ—Å—Ç–µ—Ä–æ–ª"], unit: "mmol/L" },
    { label: "HDL", patterns: ["HDL[^;]*?"], unit: "mmol/L" },
    { label: "LDL", patterns: ["LDL[^;]*?"], unit: "mmol/L" },
    { label: "–¢—Ä–∏–≥–ª–∏—Ü–µ—Ä–∏–¥–∏", patterns: ["–¢—Ä–∏–≥–ª–∏—Ü–µ—Ä–∏–¥–∏"], unit: "mmol/L" },
    { label: "–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω - —Å–µ—Ä—É–º", patterns: ["–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω - —Å–µ—Ä—É–º"], unit: "umol/L" },
    { label: "–£—Ä–µ—è", patterns: ["–£—Ä–µ—è"], unit: "mmol/L" },
    { label: "–ù–∞—Ç—Ä–∏–π", patterns: ["–ù–∞—Ç—Ä–∏–π"], unit: "mmol/L" },
    { label: "–ö–∞–ª–∏–π", patterns: ["–ö–∞–ª–∏–π(?!\\s*24)"], unit: "mmol/L" },
    { label: "–•–ª–æ—Ä–∏–¥", patterns: ["–•–ª–æ—Ä–∏–¥"], unit: "mmol/L" }
  ];
  biochem.forEach(function(p) { out += formatLineInline(p.label, extractParam(text, p.patterns, p.unit)); });
  out += '</span>\n';

  // Bold –ì–ª–∏–∫–∏—Ä–∞–Ω —Ö–µ–º–æ–≥–ª–æ–±–∏–Ω on its own line
  out += formatLineBold("–ì–ª–∏–∫–∏—Ä–∞–Ω —Ö–µ–º–æ–≥–ª–æ–±–∏–Ω", extractParam(text, ["–ì–ª–∏–∫–∏—Ä–∞–Ω —Ö–µ–º–æ–≥–ª–æ–±–∏–Ω"], "%"));

  // eGFR CKD-EPI 2021
  out += computeEGFR(text, age, sex);

  // ‚îÄ‚îÄ Glucose profiles by day ‚îÄ‚îÄ
  out += '<span class="section-label">‚ïê‚ïê‚ïê –ì–õ–Æ–ö–û–ó–ï–ù –ü–†–û–§–ò–õ ‚ïê‚ïê‚ïê</span>\n';
  out += arrangeGlucoseByDay(text);

  // ‚îÄ‚îÄ Urine by date ‚îÄ‚îÄ
  out += '<span class="section-label">‚ïê‚ïê‚ïê –£–†–ò–ù–ê ‚ïê‚ïê‚ïê</span>\n';
  out += arrangeUrineByDate(text);

  // ‚îÄ‚îÄ Albumin / Creatinine ‚îÄ‚îÄ
  out += formatLine("–ú–∏–∫—Ä–æ–∞–ª–±—É–º–∏–Ω—É—Ä–∏—è", extractParam(text, ["–£—Ä–∏–Ω–∞ - –º–∏–∫—Ä–æ–∞–ª–±—É–º–∏–Ω"], ""));
  out += formatLine("–ê–ª–±—É–º–∏–Ω –≤ —É—Ä–∏–Ω–∞", extractParam(text, ["–ê–ª–±—É–º–∏–Ω –≤ —É—Ä–∏–Ω–∞"], "mg/L"));
  var akrMatch = text.match(/\(AKR\)[^-]*?-\s*([\d.,]+)/);
  var akrVal = akrMatch ? akrMatch[1] + ' g/mol{creat}' : null;
  out += formatLine("–ê–ª–±—É–º–∏–Ω/–∫—Ä–µ–∞—Ç–∏–Ω–∏–Ω –æ—Ç–Ω–æ—à–µ–Ω–∏–µ (AKR)", akrVal);

  // EKG
  out += arrangeEKG(text);

  // Other tests
  out += '<span class="section-label">‚ïê‚ïê‚ïê –î–†–£–ì–ò –ò–ó–°–õ–ï–î–í–ê–ù–ò–Ø ‚ïê‚ïê‚ïê</span>\n';
  var otherTests = [];
  if (text.indexOf("D-–¥–∏–º–µ—Ä") !== -1) otherTests.push("D-–¥–∏–º–µ—Ä: " + (extractParam(text, ["D-–¥–∏–º–µ—Ä"], "mg/L") || ""));
  if (text.indexOf("CRP") !== -1) otherTests.push("CRP: " + (extractParam(text, ["CRP"], "mg/L") || ""));
  if (text.indexOf("–°–£–ï") !== -1) otherTests.push("–°–£–ï: " + (extractParam(text, ["–°–£–ï(?:\\s*–∞–ø–∞—Ä–∞—Ç–µ–Ω –∞–Ω–∞–ª–∏–∑)?"], "mm/h") || ""));
  if (text.indexOf("–ü—Ä–æ—Ç—Ä–æ–º–±–∏–Ω–æ–≤–æ") !== -1) otherTests.push("–ü—Ä–æ—Ç—Ä–æ–º–±–∏–Ω–æ–≤–æ –≤—Ä–µ–º–µ (INR): " + (extractParam(text, ["–ü—Ä–æ—Ç—Ä–æ–º–±–∏–Ω–æ–≤–æ –≤—Ä–µ–º–µ INR"], "") || ""));
  if (otherTests.length > 0) {
    out += '<span class="val-found">' + otherTests.join('\n') + '</span>\n';
  } else {
    out += '<span class="val-missing">–ù—è–º–∞ –¥–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ –∏–∑—Å–ª–µ–¥–≤–∞–Ω–∏—è</span>\n';
  }

  return out;
}

// ‚îÄ‚îÄ Extract glucose profiles grouped by day ‚îÄ‚îÄ
function arrangeGlucoseByDay(text) {
  var out = '';
  var blocks = text.split(/–õ–∞–±\.‚Ññ\s*/);
  var dayMap = {};  // date -> { g6, g12, g18, g24 }
  var dateOrder = [];

  for (var i = 0; i < blocks.length; i++) {
    var block = blocks[i];
    var hasGlucose = block.indexOf("–ì–ª—é–∫–æ–∑–∞ - –ø—Ä–æ—Ñ–∏–ª") !== -1 || block.indexOf("–ì–ª—é–∫–æ–∑–∞ - 24 —á") !== -1;
    if (!hasGlucose) continue;

    var dateMatch = block.match(/–î–∞—Ç–∞\s+(\d{2}\.\d{2}\.\d{4})/);
    var date = dateMatch ? dateMatch[1] : "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞ –¥–∞—Ç–∞";

    if (!dayMap[date]) {
      dayMap[date] = {};
      dateOrder.push(date);
    }

    var g6  = block.match(/–ì–ª—é–∫–æ–∑–∞ - –ø—Ä–æ—Ñ–∏–ª 6—á\s*-\s*([\d.,]+)/);
    var g12 = block.match(/–ì–ª—é–∫–æ–∑–∞ - –ø—Ä–æ—Ñ–∏–ª 12—á\s*-\s*([\d.,]+)/);
    var g18 = block.match(/–ì–ª—é–∫–æ–∑–∞ - –ø—Ä–æ—Ñ–∏–ª 18—á\s*-\s*([\d.,]+)/);
    var g24 = block.match(/–ì–ª—é–∫–æ–∑–∞ - 24 —á\.\s*-\s*([\d.,]+)/);

    if (g6  && !dayMap[date].g6)  dayMap[date].g6  = g6[1];
    if (g12 && !dayMap[date].g12) dayMap[date].g12 = g12[1];
    if (g18 && !dayMap[date].g18) dayMap[date].g18 = g18[1];
    if (g24 && !dayMap[date].g24) dayMap[date].g24 = g24[1];
  }

  if (dateOrder.length === 0) {
    out += '<span class="val-missing">–ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω –≥–ª—é–∫–æ–∑–µ–Ω –ø—Ä–æ—Ñ–∏–ª</span>\n';
  } else {
    for (var d = 0; d < dateOrder.length; d++) {
      var dt = dateOrder[d];
      var vals = [];
      if (dayMap[dt].g6)  vals.push("6—á: " + dayMap[dt].g6 + " mmol/L");
      if (dayMap[dt].g12) vals.push("12—á: " + dayMap[dt].g12 + " mmol/L");
      if (dayMap[dt].g18) vals.push("18—á: " + dayMap[dt].g18 + " mmol/L");
      if (dayMap[dt].g24) vals.push("24—á: " + dayMap[dt].g24 + " mmol/L");
      out += '<span class="val-found"><b>–î–∞—Ç–∞ ' + dt + ':</b> ' + vals.join('; ') + '</span>\n';
    }
  }
  return out;
}

// ‚îÄ‚îÄ Extract urine sediment grouped by date, with thresholds ‚îÄ‚îÄ
function arrangeUrineByDate(text) {
  var out = '';
  var blocks = text.split(/–õ–∞–±\.‚Ññ\s*/);
  var urineEntries = [];

  for (var i = 0; i < blocks.length; i++) {
    var block = blocks[i];
    var hasUrine = block.indexOf("–°–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ —Ç–µ–≥–ª–æ - —É—Ä–∏–Ω–∞") !== -1 || block.indexOf("–°–µ–¥–∏–º–µ–Ω—Ç —É—Ä–∏–Ω–∞") !== -1;
    if (!hasUrine) continue;

    var dateMatch = block.match(/–î–∞—Ç–∞\s+(\d{2}\.\d{2}\.\d{4})/);
    var date = dateMatch ? dateMatch[1] : "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞ –¥–∞—Ç–∞";

    var details = [];
    // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ —Ç–µ–≥–ª–æ
    var spTegloMatch = block.match(/–°–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ —Ç–µ–≥–ª–æ - —É—Ä–∏–Ω–∞ - —Ç–µ—Å—Ç-–ª–µ–Ω—Ç–∞ - ([\d.,]+)/);
    if (spTegloMatch) details.push("–°–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ —Ç–µ–≥–ª–æ: " + spTegloMatch[1]);

    // –ë–µ–ª—Ç—ä–∫
    var belMatch = block.match(/–ë–µ–ª—Ç—ä–∫ - —É—Ä–∏–Ω–∞ - —Ç–µ—Å—Ç-–ª–µ–Ω—Ç–∞ - ([^\s;{]+)/);
    if (belMatch && belMatch[1] !== "Neg") {
      details.push("–ë–µ–ª—Ç—ä–∫: " + belMatch[1]);
    } else if (belMatch) {
      details.push("–ë–µ–ª—Ç—ä–∫: negative");
    }

    // –ì–ª—é–∫–æ–∑–∞ - —É—Ä–∏–Ω–∞
    var gluMatch = block.match(/–ì–ª—é–∫–æ–∑–∞ - —É—Ä–∏–Ω–∞ - —Ç–µ—Å—Ç-–ª–µ–Ω—Ç–∞ - ([^\s;{]+)/);
    if (gluMatch) {
      details.push("–ì–ª—é–∫–æ–∑–∞: " + (gluMatch[1] === "Neg" ? "negative" : gluMatch[1]));
    }

    // –ö–µ—Ç–æ—Ç–µ–ª–∞ ‚Äî highlighted in red (important marker)
    var ketMatch = block.match(/–ö–µ—Ç–æ—Ç–µ–ª–∞ - —É—Ä–∏–Ω–∞ - —Ç–µ—Å—Ç-–ª–µ–Ω—Ç–∞ - ([^\s;{]+)/);
    if (ketMatch) {
      if (ketMatch[1] === "Neg") {
        details.push("–ö–µ—Ç–æ—Ç–µ–ª–∞: negative");
      } else {
        details.push('<span class="val-ketone">–ö–µ—Ç–æ—Ç–µ–ª–∞: ' + ketMatch[1] + '</span>');
      }
    }

    // –°–µ–¥–∏–º–µ–Ω—Ç –õ–ï–í–ö–û–¶–ò–¢–ò > 50
    var leuMatch = block.match(/–°–µ–¥–∏–º–µ–Ω—Ç —É—Ä–∏–Ω–∞ - –õ–ï–í–ö–û–¶–ò–¢–ò - ([\d.,]+)/);
    if (leuMatch && parseFloat(leuMatch[1]) > 50) {
      details.push("–õ–ï–í–ö–û–¶–ò–¢–ò - " + leuMatch[1] + " cells/uL ‚ö†Ô∏è");
    }

    // –°–µ–¥–∏–º–µ–Ω—Ç –ï–†–ò–¢–†–û–¶–ò–¢–ò > 20
    var eryMatch = block.match(/–°–µ–¥–∏–º–µ–Ω—Ç —É—Ä–∏–Ω–∞ - –ï–†–ò–¢–†–û–¶–ò–¢–ò - ([\d.,]+)/);
    if (eryMatch && parseFloat(eryMatch[1]) > 20) {
      details.push("–ï–†–ò–¢–†–û–¶–ò–¢–ò - " + eryMatch[1] + "/uL ‚ö†Ô∏è");
    }

    // –±–∞–∫—Ç–µ—Ä–∏–∏ > 2.0
    var bacMatch = block.match(/–°–µ–¥–∏–º–µ–Ω—Ç —É—Ä–∏–Ω–∞ - –±–∞–∫—Ç–µ—Ä–∏–∏ - ([\d.,]+)/);
    if (bacMatch && parseFloat(bacMatch[1]) > 2.0) {
      details.push("–ë–∞–∫—Ç–µ—Ä–∏–∏ - " + bacMatch[1] + "/uL ‚ö†Ô∏è");
    }

    // Candida > 2.0
    var candMatch = block.match(/–°–µ–¥–∏–º–µ–Ω—Ç —É—Ä–∏–Ω–∞ - –º–∏–∫—Ä–æ—Å–∫–æ–ø–∏—á–Ω–∏ –≥—ä–±–∏—á–∫–∏ \(Candida\) - ([\d.,]+)/);
    if (candMatch && parseFloat(candMatch[1]) > 2.0) {
      details.push("Candida - " + candMatch[1] + "/uL ‚ö†Ô∏è");
    }

    if (details.length > 0) {
      urineEntries.push({ date: date, details: details });
    }
  }

  if (urineEntries.length === 0) {
    out += '<span class="val-missing">–ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞ —É—Ä–∏–Ω–∞</span>\n';
  } else {
    for (var u = 0; u < urineEntries.length; u++) {
      out += '<span class="val-found"><b>–î–∞—Ç–∞ ' + urineEntries[u].date + ':</b> ' + urineEntries[u].details.join('; ') + '</span>\n';
    }
  }
  return out;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ARRANGE: –ö–ü 79.1
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function arrangeKP79(text) {
  var out = '';

  out += '<span class="section-label">‚ïê‚ïê‚ïê –ö–†–™–í–ù–ò –ò–ó–°–õ–ï–î–í–ê–ù–ò–Ø ‚ïê‚ïê‚ïê</span>\n';
  out += arrangeBloodCount(text);

  out += '<span class="section-label">‚ïê‚ïê‚ïê –¢–ò–†–ï–û–ò–î–ù–ò –ò–ó–°–õ–ï–î–í–ê–ù–ò–Ø ‚ïê‚ïê‚ïê</span>\n';
  var thyroid = [
    { label: "FT4", patterns: ["FT4"], unit: "pmol/L" },
    { label: "fT3", patterns: ["fT3", "FT3"], unit: "pmol/L" },
    { label: "TSH", patterns: ["TSH"], unit: "u[IU]/mL" },
    { label: "Anti TG (TAT)", patterns: ["Anti TG(?:\\s*/?TAT/?)?"], unit: "[IU]/mL" },
    { label: "Anti-TPO (MAT)", patterns: ["Anti-TPO(?:\\s*/?MAT/?)?"], unit: "U/mL" },
    { label: "–¢–∏—Ä–µ–æ—Ç—Ä–æ–ø–∏–Ω —Ä–µ—Ü–µ–ø—Ç–æ—Ä–Ω–∏ –∞–Ω—Ç–∏—Ç–µ–ª–∞", patterns: ["—Ç–∏—Ä–µ–æ—Ç—Ä–æ–ø–∏–Ω —Ä–µ—Ü–µ–ø—Ç–æ—Ä", "TRAB", "TRAb", "TSH —Ä–µ—Ü–µ–ø—Ç–æ—Ä"], unit: "" }
  ];
  thyroid.forEach(function(p) {
    var val = extractParam(text, p.patterns, p.unit);
    if (val || p.label === "FT4" || p.label === "TSH" || p.label === "Anti TG (TAT)" || p.label === "Anti-TPO (MAT)") {
      out += formatLine(p.label, val);
    }
  });

  // –£–ó–î
  out += arrangeUZD(text);

  // –ï–ö–ì
  out += arrangeEKG(text);

  return out;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ARRANGE: –ö–ü 80.1
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function arrangeKP80(text) {
  var out = '';

  out += '<span class="section-label">‚ïê‚ïê‚ïê –ö–†–™–í–ù–ò –ò–ó–°–õ–ï–î–í–ê–ù–ò–Ø ‚ïê‚ïê‚ïê</span>\n';
  out += arrangeBloodCount(text);

  out += '<span class="section-label">‚ïê‚ïê‚ïê –•–û–†–ú–û–ù–ê–õ–ù–ò –ò–ó–°–õ–ï–î–í–ê–ù–ò–Ø ‚ïê‚ïê‚ïê</span>\n';
  var hormones = [
    { label: "FT4", patterns: ["FT4"], unit: "pmol/L" },
    { label: "TSH", patterns: ["TSH"], unit: "u[IU]/mL" },
    { label: "–ö–æ—Ä—Ç–∏–∑–æ–ª - —Å–µ—Ä—É–º", patterns: ["–ö–æ—Ä—Ç–∏–∑–æ–ª(?:\\s*-\\s*—Å–≤–æ–±–æ–¥–µ–Ω)?(?:\\s*,?\\s*—Å–µ—Ä—É–º)?"], unit: "nmol/L" },
    { label: "LH", patterns: ["LH(?:\\s*\\(–ª—É—Ç–µ–∏–Ω–∏–∑–∏—Ä–∞—â —Ö–æ—Ä–º–æ–Ω\\))?"], unit: "m[IU]/mL" },
    { label: "FSH", patterns: ["FSH(?:\\s*\\(—Ñ–æ–ª–∏–∫—É–ª–æ-—Å—Ç–∏–º—É–ª–∏—Ä–∞—â —Ö–æ—Ä–º–æ–Ω\\))?"], unit: "m[IU]/mL" },
    { label: "–ï—Å—Ç—Ä–∞–¥–∏–æ–ª", patterns: ["–ï—Å—Ç—Ä–∞–¥–∏–æ–ª"], unit: "pmol/L" },
    { label: "–¢–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω", patterns: ["–¢–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω", "Testosteron"], unit: "" },
    { label: "GH / –†–∞—Å—Ç–µ–∂–µ–Ω —Ö–æ—Ä–º–æ–Ω", patterns: ["–†–∞—Å—Ç–µ–∂–µ–Ω —Ö–æ—Ä–º–æ–Ω(?:\\s*/CTX/)?", "GH"], unit: "ng/mL" },
    { label: "IGF-I", patterns: ["–ò–Ω—Å—É–ª–∏–Ω–æ-–ø–æ–¥–æ–±–µ–Ω —Ä–∞—Å—Ç–µ–∂–µ–Ω —Ö–æ—Ä–º–æ–Ω 1 \\(IGF-I\\)", "IGF-I", "IGF-1", "IGF1"], unit: "ng/mL" },
    { label: "–ê–ö–¢–•", patterns: ["–ê–ö–¢–•", "AKTH", "ACTH"], unit: "pg/mL" },
    { label: "–ü—Ä–æ–ª–∞–∫—Ç–∏–Ω", patterns: ["–ü—Ä–æ–ª–∞–∫—Ç–∏–Ω", "Prolactin"], unit: "" }
  ];
  out += '<span class="inline-results">';
  hormones.forEach(function(p) {
    var val = extractParam(text, p.patterns, p.unit);
    if (val) { out += formatLineInline(p.label, val); }
  });
  out += '</span>\n';
  var anyHormone = hormones.some(function(p) { return extractParam(text, p.patterns, "") !== null; });
  if (!anyHormone) {
    out += '<span class="val-missing">–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Ö–æ—Ä–º–æ–Ω–∞–ª–Ω–∏ –∏–∑—Å–ª–µ–¥–≤–∞–Ω–∏—è</span>\n';
  }

  // –ö–æ—Ä—Ç–∏–∑–æ–ª —É—Ä–∏–Ω–∞ 24—á
  out += formatLine("–ö–æ—Ä—Ç–∏–∑–æ–ª - —É—Ä–∏–Ω–∞ 24—á", extractParam(text, ["–ö–æ—Ä—Ç–∏–∑–æ–ª(?:\\s*-\\s*—Å–≤–æ–±–æ–¥–µ–Ω)?(?:\\s*,?\\s*—É—Ä–∏–Ω–∞\\s*24)"], "ug/(24.h)"));

  // ‚îÄ‚îÄ Urine by date ‚îÄ‚îÄ
  out += '<span class="section-label">‚ïê‚ïê‚ïê –£–†–ò–ù–ê ‚ïê‚ïê‚ïê</span>\n';
  out += arrangeUrineByDate(text);

  out += '<span class="section-label">‚ïê‚ïê‚ïê –û–ë–†–ê–ó–ù–ò –ò–ó–°–õ–ï–î–í–ê–ù–ò–Ø ‚ïê‚ïê‚ïê</span>\n';
  var uzdText = extractFreeText(text, ["–ï–•–û–ì–†–ê–§–ò–Ø –ù–ê –®–ò–Ø", "–£–ó–î –Ω–∞ —à–∏—è", "–ï—Ö–æ–≥—Ä–∞—Ñ–∏—è –Ω–∞ —à–∏—è"]);
  if (uzdText) out += '<span class="val-found">–£–ó–î –Ω–∞ —à–∏—è: ' + uzdText + '</span>\n';

  var mrText = extractFreeText(text, ["–•–ò–ü–û–§–ò–ó–ê –ú–†", "–ú–† –Ω–∞ —Ö–∏–ø–æ—Ñ–∏–∑–∞", "—Ö–∏–ø–æ—Ñ–∏–∑–∞ –º—Ä"]);
  if (mrText) out += '<span class="val-found">–ú–† —Ö–∏–ø–æ—Ñ–∏–∑–∞: ' + mrText + '</span>\n';

  var ktText = extractFreeText(text, ["–ö–¢ ", "KT ", "–ö–æ–º–ø—é—Ç—ä—Ä–Ω–∞ —Ç–æ–º–æ–≥—Ä–∞—Ñ–∏—è"]);
  if (ktText) out += '<span class="val-found">–ö–¢: ' + ktText + '</span>\n';

  var echoText = extractFreeText(text, ["–ï—Ö–æ—Å–∫–æ–ø–∏—è –Ω–∞ –∫–æ—Ä–µ–º–Ω–∏ –æ—Ä–≥–∞–Ω–∏", "–µ—Ö–æ—Å–∫–æ–ø–∏—è –Ω–∞ –∫–æ—Ä–µ–º–Ω–∏ –æ—Ä–≥–∞–Ω–∏"]);
  if (echoText) out += '<span class="val-found">–ï—Ö–æ—Å–∫–æ–ø–∏—è: ' + echoText + '</span>\n';

  var xrayText = extractFreeText(text, ["–†–ï–ù–¢–ì–ï–ù–û–ì–†–ê–§–ò–Ø", "–†–µ–Ω—Ç–≥–µ–Ω–æ–≥—Ä–∞—Ñ–∏—è"]);
  if (xrayText) out += '<span class="val-found">–†–µ–Ω—Ç–≥–µ–Ω–æ–≥—Ä–∞—Ñ–∏—è: ' + xrayText + '</span>\n';

  if (!uzdText && !mrText && !ktText && !echoText && !xrayText) {
    out += '<span class="val-missing">–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ –æ–±—Ä–∞–∑–Ω–∏ –∏–∑—Å–ª–µ–¥–≤–∞–Ω–∏—è</span>\n';
  }

  // –ï–ö–ì
  out += arrangeEKG(text);

  return out;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ARRANGE: –ê–ü 13
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function arrangeAP13(text) {
  var out = '';

  // Blood count (if available)
  var hasBlood = text.indexOf("–õ–µ–≤–∫–æ—Ü–∏—Ç–∏") !== -1;
  if (hasBlood) {
    out += '<span class="section-label">‚ïê‚ïê‚ïê –ö–†–™–í–ù–ò –ò–ó–°–õ–ï–î–í–ê–ù–ò–Ø ‚ïê‚ïê‚ïê</span>\n';
    out += arrangeBloodCount(text);

    // Thyroid panel
    var thyroid = [
      { label: "FT4", patterns: ["FT4"], unit: "pmol/L" },
      { label: "TSH", patterns: ["TSH"], unit: "u[IU]/mL" },
      { label: "Anti TG (TAT)", patterns: ["Anti TG(?:\\s*/?TAT/?)?"], unit: "[IU]/mL" },
      { label: "Anti-TPO (MAT)", patterns: ["Anti-TPO(?:\\s*/?MAT/?)?"], unit: "U/mL" }
    ];
    thyroid.forEach(function(p) { out += formatLine(p.label, extractParam(text, p.patterns, p.unit)); });
  }

  // –£–ó–î –Ω–∞ —à–∏—è
  out += arrangeUZD(text);

  // –¶–∏—Ç–æ–ª–æ–≥–∏—á–Ω–æ –∏–∑—Å–ª–µ–¥–≤–∞–Ω–µ
  out += '<span class="section-label">‚ïê‚ïê‚ïê –¶–ò–¢–û–õ–û–ì–ò–Ø ‚ïê‚ïê‚ïê</span>\n';
  var cytoText = extractFreeText(text, ["–¶–∏—Ç–æ–ª–æ–≥–∏—á–Ω–æ –∏–∑—Å–ª–µ–¥–≤–∞–Ω–µ", "—Ü–∏—Ç–æ–ª–æ–≥–∏—á–Ω–æ –∏–∑—Å–ª–µ–¥–≤–∞–Ω–µ", "—Ç—ä–Ω–∫–æ–∏–≥–ª–µ–Ω–∞ –∞—Å–ø–∏—Ä–∞—Ü–∏–æ–Ω–Ω–∞ –±–∏–æ–ø—Å–∏—è", "–¢–ê–ë"]);
  if (cytoText) {
    out += '<span class="val-found">' + cytoText + '</span>\n';
  } else {
    out += '<span class="val-missing">–ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–æ —Ü–∏—Ç–æ–ª–æ–≥–∏—á–Ω–æ –∏–∑—Å–ª–µ–¥–≤–∞–Ω–µ</span>\n';
  }

  return out;
}

function arrangeResults(pathway, text, age, sex) {
  switch (pathway) {
    case "–ö–ü 78.1": return arrangeKP78(text, age, sex);
    case "–ö–ü 79.1": return arrangeKP79(text);
    case "–ö–ü 80.1": return arrangeKP80(text);
    case "–ö–ü 81.1": return arrangeKP81(text);
    case "–ê–ü 13":   return arrangeAP13(text);
    default: return null;
  }
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UI LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var CONFIGURED = ["–ê–ü 13", "–ö–ü 78.1", "–ö–ü 79.1", "–ö–ü 80.1", "–ö–ü 81.1"];
var ARRANGE_CONFIGURED = ["–ê–ü 13", "–ö–ü 78.1", "–ö–ü 79.1", "–ö–ü 80.1", "–ö–ü 81.1"];

var pathwayEl = document.getElementById("pathway");
var inputEl   = document.getElementById("inputText");
var checkBtn  = document.getElementById("checkBtn");
var arrangeBtn = document.getElementById("arrangeBtn");
var resetBtn  = document.getElementById("resetBtn");
var resultsEl = document.getElementById("results");
var arrangedEl = document.getElementById("arranged");
var reminderPanel = document.getElementById("reminderPanel");
var reminderText  = document.getElementById("reminderText");

function updateBtns() {
  var hasInput = pathwayEl.value && inputEl.value.trim();
  checkBtn.disabled = !hasInput;
  arrangeBtn.disabled = !hasInput || !ARRANGE_CONFIGURED.includes(pathwayEl.value);
}

function showReminder() {
  var pw = pathwayEl.value;
  if (REMINDERS[pw]) {
    reminderText.textContent = REMINDERS[pw];
    reminderPanel.classList.add("visible");
  } else {
    reminderPanel.classList.remove("visible");
  }
}

pathwayEl.addEventListener("change", function() {
  updateBtns(); resultsEl.innerHTML = ""; arrangedEl.innerHTML = ""; showReminder();
});
inputEl.addEventListener("input", function() {
  updateBtns(); resultsEl.innerHTML = ""; arrangedEl.innerHTML = "";
});
resetBtn.addEventListener("click", function() {
  pathwayEl.selectedIndex = 0;
  inputEl.value = ""; inputEl.textContent = "";
  resultsEl.innerHTML = ""; arrangedEl.innerHTML = "";
  checkBtn.disabled = true; arrangeBtn.disabled = true;
  reminderPanel.classList.remove("visible");
  inputEl.focus();
});

// ‚îÄ‚îÄ Check button ‚îÄ‚îÄ
checkBtn.addEventListener("click", function() {
  arrangedEl.innerHTML = "";
  var pathway = pathwayEl.value;
  var text = normalizeText(inputEl.value);
  if (!CONFIGURED.includes(pathway)) {
    resultsEl.innerHTML = '<div class="warning-box">‚ö†Ô∏è –¢–∞–∑–∏ –∫–ª–∏–Ω–∏—á–Ω–∞ –ø—ä—Ç–µ–∫–∞ –≤—Å–µ –æ—â–µ –Ω–µ –µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω–∞.</div>';
    return;
  }
  var result = checkPathway(pathway, text);
  if (!result) return;
  var items = result.items;
  var warnings = result.warnings;
  var checkable = items.filter(function(i) { return i.type === "required" || i.type === "oneOf"; });
  var foundCount = checkable.filter(function(i) { return i.found; }).length;
  var totalCount = checkable.length;
  var missingItems = checkable.filter(function(i) { return !i.found; });
  var pct = Math.round((foundCount / totalCount) * 100);
  var barClass = pct === 100 ? "green" : pct > 60 ? "yellow" : "red";

  var html = '<div class="progress-header"><span>–ù–∞–º–µ—Ä–µ–Ω–∏: ' + foundCount + ' / ' + totalCount + '</span><span>' + pct + '%</span></div>' +
    '<div class="progress-bar"><div class="progress-fill ' + barClass + '" style="width:' + pct + '%"></div></div>';
  if (missingItems.length === 0) {
    html += '<div class="banner banner-success"><div class="banner-icon">‚úÖ</div><h2>Mission complete!</h2>' +
      '<p class="sub">–í—Å–∏—á–∫–∏ ' + totalCount + ' –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏ –∏–∑—Å–ª–µ–¥–≤–∞–Ω–∏—è —Å–∞ –Ω–∞–ª–∏—á–Ω–∏.</p></div>';
  } else {
    var missingText = missingItems.length === 1
      ? '‚Äû' + missingItems[0].label + '" –ª–∏–ø—Å–≤–∞!'
      : missingItems.length + ' –∏–∑—Å–ª–µ–¥–≤–∞–Ω–∏—è –ª–∏–ø—Å–≤–∞—Ç!';
    var tags = missingItems.map(function(m) {
      var cls = m.type === "oneOf" ? "tag tag-group" : "tag";
      return '<span class="' + cls + '">‚ùå ' + m.label + '</span>';
    }).join("");
    html += '<div class="banner banner-fail"><div class="banner-icon">‚ö°</div><h2>Stop!</h2>' +
      '<p class="sub">' + missingText + '</p><div class="missing-tags">' + tags + '</div></div>';
  }
  warnings.forEach(function(w) {
    html += '<div class="warning-banner"><div class="warning-banner-text">üíä ' + w + '</div></div>';
  });
  var detailItems = items.map(function(r) {
    if (r.type === "conditional-info") {
      return '<div class="detail-item group-header">' + r.label + '</div>';
    }
    if (r.type === "oneOf") {
      var mainCls = r.found ? "found" : "missing";
      var mainIcon = r.found ? "‚úÖ" : "‚ùå";
      var sub = '';
      if (r.subItems) {
        sub = r.subItems.map(function(s) {
          var sCls = s.found ? "group-ok" : "group-fail";
          var sIcon = s.found ? "‚úÖ" : "‚¨ú";
          return '<div class="detail-item ' + sCls + '" style="padding-left:28px;font-size:12px;"><span class="detail-icon">' + sIcon + '</span><span>' + s.label + '</span></div>';
        }).join("");
      }
      return '<div class="detail-item ' + mainCls + '" style="grid-column:1/-1;font-weight:700;"><span class="detail-icon">' + mainIcon + '</span><span>' + r.label + '</span></div>' + sub;
    }
    var cls = r.found ? "found" : "missing";
    var icon = r.found ? "‚úÖ" : "‚ùå";
    return '<div class="detail-item ' + cls + '"><span class="detail-icon">' + icon + '</span><span>' + r.label + '</span></div>';
  }).join("");
  var showGrid = missingItems.length > 0 ? "grid" : "none";
  html += '<button class="details-toggle" onclick="toggleDetails()"><span id="detailArrow">' + (missingItems.length > 0 ? '‚ñº' : '‚ñ∂') + '</span> –î–µ—Ç–∞–π–ª–µ–Ω –ø—Ä–µ–≥–ª–µ–¥</button>' +
    '<div class="details-grid" id="detailsGrid" style="display:' + showGrid + '">' + detailItems + '</div>';
  resultsEl.innerHTML = html;
});

// ‚îÄ‚îÄ Arrange button ‚îÄ‚îÄ
var NEEDS_EGFR = ["–ö–ü 78.1"];

arrangeBtn.addEventListener("click", function() {
  resultsEl.innerHTML = "";
  var pathway = pathwayEl.value;
  var text = normalizeText(inputEl.value);

  if (NEEDS_EGFR.includes(pathway)) {
    // Show patient input panel first
    arrangedEl.innerHTML = '<div class="patient-input-panel">' +
      '<h3>üßÆ –í—ä–≤–µ–¥–µ—Ç–µ –¥–∞–Ω–Ω–∏ –∑–∞ eGFR (CKD-EPI 2021):</h3>' +
      '<div class="patient-fields">' +
        '<div class="patient-field"><label>–í—ä–∑—Ä–∞—Å—Ç (–≥–æ–¥–∏–Ω–∏)</label><br>' +
          '<input type="number" id="patientAge" min="18" max="120" placeholder="–Ω–∞–ø—Ä. 65"></div>' +
        '<div class="patient-field"><label>–ü–æ–ª</label><br>' +
          '<select id="patientSex"><option value="">‚Äî –∏–∑–±–µ—Ä–∏ ‚Äî</option><option value="male">–ú—ä–∂</option><option value="female">–ñ–µ–Ω–∞</option></select></div>' +
        '<div class="patient-field"><button class="btn-compute" id="computeBtn">üìã –ü–æ–∫–∞–∂–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏</button></div>' +
      '</div></div>';

    document.getElementById("computeBtn").addEventListener("click", function() {
      var age = parseInt(document.getElementById("patientAge").value) || 0;
      var sex = document.getElementById("patientSex").value;
      if (!age || !sex) {
        alert("–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤—ä–∑—Ä–∞—Å—Ç –∏ –ø–æ–ª.");
        return;
      }
      var arranged = arrangeResults(pathway, text, age, sex);
      if (!arranged) return;
      arrangedEl.innerHTML = '<div class="arranged-output">' +
        '<div class="arranged-header"><span>üìã –ü–æ–¥—Ä–µ–¥–µ–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ ‚Äî ' + pathway + '</span>' +
        '<button class="btn-copy" onclick="copyArranged()">üìÑ –ö–æ–ø–∏—Ä–∞–π</button></div>' +
        '<div class="arranged-body" id="arrangedBody">' + arranged + '</div></div>';
    });
    return;
  }

  // No eGFR needed ‚Äî show directly
  var arranged = arrangeResults(pathway, text, null, null);
  if (!arranged) {
    arrangedEl.innerHTML = '<div class="warning-box">‚ö†Ô∏è –ü–æ–¥—Ä–µ–∂–¥–∞–Ω–µ –∑–∞ —Ç–∞–∑–∏ –ø—ä—Ç–µ–∫–∞ –Ω–µ –µ –Ω–∞–ª–∏—á–Ω–æ –≤—Å–µ –æ—â–µ.</div>';
    return;
  }
  arrangedEl.innerHTML = '<div class="arranged-output">' +
    '<div class="arranged-header"><span>üìã –ü–æ–¥—Ä–µ–¥–µ–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ ‚Äî ' + pathway + '</span>' +
    '<button class="btn-copy" onclick="copyArranged()">üìÑ –ö–æ–ø–∏—Ä–∞–π</button></div>' +
    '<div class="arranged-body" id="arrangedBody">' + arranged + '</div></div>';
});

function copyArranged() {
  var body = document.getElementById("arrangedBody");
  if (!body) return;
  var text = body.innerText;
  navigator.clipboard.writeText(text).then(function() {
    var btn = document.querySelector(".btn-copy");
    if (btn) { btn.textContent = "‚úÖ –ö–æ–ø–∏—Ä–∞–Ω–æ!"; setTimeout(function() { btn.textContent = "üìÑ –ö–æ–ø–∏—Ä–∞–π"; }, 2000); }
  });
}

function toggleDetails() {
  var grid = document.getElementById("detailsGrid");
  var arrow = document.getElementById("detailArrow");
  if (grid.style.display === "none") { grid.style.display = "grid"; arrow.textContent = "‚ñº"; }
  else { grid.style.display = "none"; arrow.textContent = "‚ñ∂"; }
}
</script>
</body>
</html>
